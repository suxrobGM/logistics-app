<shared-page-header title="Vehicle Condition Reports" [showAddButton]="false" />

<p-card>
  <shared-data-container
    [loading]="store.isLoading()"
    [error]="store.error()"
    [isEmpty]="store.isEmpty()"
    skeletonVariant="table"
    [skeletonRows]="10"
    emptyTitle="No condition reports yet"
    emptyMessage="Vehicle condition reports will appear here when captured from the Driver App."
    (retry)="store.load()"
  >
    <p-table
      [value]="store.filteredData()"
      dataKey="id"
      [scrollable]="true"
      [paginator]="true"
      [showCurrentPageReport]="true"
      [rows]="10"
      [totalRecords]="store.totalRecords()"
      [loading]="store.isLoading()"
      [rowsPerPageOptions]="[10, 25, 50]"
    >
      <ng-template #caption>
        <shared-search-input (searchChange)="onSearch($event)" />
      </ng-template>
      <ng-template #header>
        <tr>
          <th pSortableColumn="type" class="w-28">
            Type
            <p-sortIcon field="type" />
          </th>
          <th pSortableColumn="vin">
            VIN
            <p-sortIcon field="vin" />
          </th>
          <th>Vehicle</th>
          <th class="w-28">Damages</th>
          <th pSortableColumn="inspectorName">
            Inspector
            <p-sortIcon field="inspectorName" />
          </th>
          <th pSortableColumn="inspectedAt">
            Inspected At
            <p-sortIcon field="inspectedAt" />
          </th>
          <th class="w-24">Photos</th>
          <th class="w-24">Signature</th>
          <th class="w-24">Action</th>
        </tr>
      </ng-template>
      <ng-template #body let-report>
        <tr
          class="cursor-pointer hover:bg-gray-50"
          (click)="selectedRow.set(report)"
        >
          <td>
            <p-tag
              [value]="getTypeLabel(report.type)"
              [severity]="getTypeSeverity(report.type)"
            />
          </td>
          <td>
            <span class="font-mono text-sm">{{ report.vin || 'N/A' }}</span>
          </td>
          <td>
            <span class="text-sm">{{ getVehicleInfo(report) }}</span>
            @if (report.vehicleBodyClass) {
              <span class="block text-xs text-gray-500">{{ report.vehicleBodyClass }}</span>
            }
          </td>
          <td>
            @if (getDamageCount(report) > 0) {
              <p-tag
                [value]="getDamageCount(report).toString() + ' damages'"
                severity="danger"
              />
            } @else {
              <span class="text-sm text-gray-400">None</span>
            }
          </td>
          <td>{{ report.inspectorName || 'N/A' }}</td>
          <td>{{ report.inspectedAt | date: 'medium' }}</td>
          <td>
            @if (report.photos && report.photos.length > 0) {
              <span class="text-sm">{{ report.photos.length }} photo(s)</span>
            } @else {
              <span class="text-sm text-gray-400">None</span>
            }
          </td>
          <td>
            @if (report.hasSignature) {
              <i class="pi pi-check text-green-500"></i>
            } @else {
              <i class="pi pi-times text-gray-400"></i>
            }
          </td>
          <td>
            <p-button
              icon="pi pi-ellipsis-v"
              (click)="openActionMenu(report, menu, $event); $event.stopPropagation()"
              severity="secondary"
              [text]="true"
            />
          </td>
        </tr>
      </ng-template>
    </p-table>
  </shared-data-container>
</p-card>

<!-- Reusable context menu for the actions button -->
<p-menu #menu [model]="actionMenuItems" [popup]="true" />
