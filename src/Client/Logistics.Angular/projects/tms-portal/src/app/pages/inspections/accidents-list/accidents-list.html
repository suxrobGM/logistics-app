<ui-page-header
  title="Accident Reports"
  addRoute="/inspections/accidents/add"
  addTooltip="Report a new accident"
/>

<p-card>
  <div class="mb-4">
    <ui-search-input (searchChange)="onSearch($event)" />
  </div>
  <ui-data-container
    [loading]="store.isLoading()"
    [error]="store.error()"
    [isEmpty]="store.isEmpty()"
    skeletonVariant="table"
    [skeletonRows]="10"
    emptyTitle="No accident reports"
    emptyMessage="No accidents have been reported. We hope it stays that way!"
    emptyActionLabel="Report Accident"
    (retry)="store.retry()"
    (emptyAction)="addAccident()"
  >
    <p-table
      [value]="store.data()"
      [lazy]="true"
      [paginator]="true"
      [showCurrentPageReport]="true"
      (onLazyLoad)="store.onLazyLoad($event)"
      [rows]="store.pageSize()"
      [first]="store.first()"
      [totalRecords]="store.totalRecords()"
      [loading]="store.isLoading()"
      [rowsPerPageOptions]="[10, 25, 50]"
    >
      <ng-template #header>
        <tr>
          <th pSortableColumn="AccidentDateTime">
            Date
            <p-sortIcon field="AccidentDateTime" />
          </th>
          <th pSortableColumn="TruckNumber">
            Truck
            <p-sortIcon field="TruckNumber" />
          </th>
          <th pSortableColumn="DriverName">
            Driver
            <p-sortIcon field="DriverName" />
          </th>
          <th>Location</th>
          <th>Severity</th>
          <th>Injuries</th>
          <th>Status</th>
          <th></th>
        </tr>
      </ng-template>
      <ng-template #body let-accident>
        <tr class="hover:bg-hover cursor-pointer" (click)="onRowClick(accident)">
          <td>{{ accident.accidentDateTime | date: "short" }}</td>
          <td>{{ accident.truckNumber || "-" }}</td>
          <td>{{ accident.driverName || "-" }}</td>
          <td>{{ accident.location || "-" }}</td>
          <td>
            <p-tag
              [value]="getSeverityLabel(accident.severity)"
              [severity]="getSeveritySeverity(accident.severity)"
            />
          </td>
          <td>
            @if (accident.injuriesReported) {
              <span class="text-danger font-medium">
                <i class="pi pi-exclamation-triangle mr-1"></i>
                Yes
              </span>
            } @else {
              <span class="text-success">No</span>
            }
          </td>
          <td>
            <p-tag
              [value]="getStatusLabel(accident.status)"
              [severity]="getStatusSeverity(accident.status)"
            />
          </td>
          <td>
            <p-button
              icon="pi pi-ellipsis-v"
              [text]="true"
              aria-label="Show actions menu"
              (click)="$event.stopPropagation(); selectedRow.set(accident); menu.toggle($event)"
            />
          </td>
        </tr>
      </ng-template>
    </p-table>
  </ui-data-container>
</p-card>

<!-- Context menu for row actions -->
<p-menu #menu [model]="actionMenuItems" [popup]="true" />
