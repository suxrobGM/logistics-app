<ui-page-header
  title="Add New Payroll"
  [showAddButton]="false"
  [centered]="true"
  backLink="/payroll/invoices"
/>

<div class="mx-auto max-w-4xl">
  <p-card>
    <form [formGroup]="form" (ngSubmit)="submit()">
      <ui-validation-summary [form]="form" />

      <!-- Mode Toggle -->
      <ui-labeled-field label="Creation Mode">
        <p-select-button
          [options]="modeOptions"
          [ngModel]="mode()"
          [ngModelOptions]="{ standalone: true }"
          (onChange)="onModeChange($event.value)"
          optionLabel="label"
          optionValue="value"
        >
          <ng-template #item let-item>
            <div class="flex items-center gap-2">
              <i [class]="item.icon"></i>
              <span>{{ item.label }}</span>
            </div>
          </ng-template>
        </p-select-button>
      </ui-labeled-field>

      <!-- Date Range Section -->
      <ui-labeled-field label="Pay Period" [control]="form.controls.dateRange">
        <ui-date-range-picker
          [dates]="form.value.dateRange ?? []"
          (datesChange)="onDateRangeChange($event)"
        />
      </ui-labeled-field>

      <!-- Single Mode: Employee Selection -->
      @if (mode() === "single") {
        <ui-labeled-field label="Employee" [control]="form.controls.employee" [required]="true">
          <p-autocomplete
            formControlName="employee"
            class="w-full"
            inputStyleClass="w-full"
            placeholder="Type employee's name"
            optionLabel="fullName"
            [minLength]="2"
            [suggestions]="suggestedEmployees()"
            (completeMethod)="searchEmployee($event)"
            (onSelect)="handleAutoCompleteSelectEvent($event)"
          />
        </ui-labeled-field>

        <!-- Single Mode Preview -->
        @if (selectedEmployee() && previewPayrollInvoice()) {
          <p-divider />
          <h4 class="text-primary mb-4 font-semibold">Preview Payroll Invoice</h4>

          <div class="bg-surface-50 dark:bg-surface-800 mb-6 grid grid-cols-2 gap-4 rounded-lg p-4">
            <div>
              <span class="text-muted text-sm">Employee</span>
              <p class="text-primary font-medium">{{ selectedEmployee()!.fullName }}</p>
            </div>
            <div>
              <span class="text-muted text-sm">Role</span>
              <p class="text-primary font-medium">
                {{ selectedEmployee()!.role?.displayName ?? "N/A" }}
              </p>
            </div>
            <div>
              <span class="text-muted text-sm">Salary Type</span>
              <p class="text-primary font-medium">
                {{ getSalaryTypeDesc(selectedEmployee()!.salaryType) }}
              </p>
            </div>
            <div>
              <span class="text-muted text-sm">Rate</span>
              <p class="text-primary font-medium">
                @if (selectedEmployee()!.salaryType === "share_of_gross") {
                  {{ selectedEmployee()!.salary | percent }}
                } @else {
                  {{ selectedEmployee()!.salary | currency }}
                }
              </p>
            </div>
            <div class="col-span-2">
              <span class="text-muted text-sm">Expected Invoice Total</span>
              <p class="text-success text-xl font-bold">
                {{ previewPayrollInvoice()!.total?.amount | currency }}
              </p>
            </div>
          </div>
        }

        <div class="flex gap-2">
          <p-button
            type="submit"
            icon="pi pi-plus"
            label="Create Payroll"
            [loading]="isLoading()"
            [disabled]="!form.valid || previewPayrollInvoice()?.total?.amount === 0"
          />
          <p-button
            type="button"
            icon="pi pi-arrow-left"
            label="Back to list"
            [routerLink]="['/payroll/invoices']"
          />
        </div>
      }

      <!-- Bulk Mode: Multiple Employees -->
      @if (mode() === "bulk") {
        <ui-labeled-field label="Select Employees">
          <p-multi-select
            [options]="allEmployees()"
            [ngModel]="selectedEmployees()"
            [ngModelOptions]="{ standalone: true }"
            (ngModelChange)="onSelectedEmployeesChange($event)"
            optionLabel="fullName"
            placeholder="Select employees"
            [filter]="true"
            filterPlaceHolder="Search employees..."
            [showClear]="true"
            display="chip"
            class="w-full"
          />
        </ui-labeled-field>

        <!-- Bulk Preview Table -->
        @if (bulkPreviews().length > 0) {
          <p-divider />
          <div class="mb-4 flex items-center justify-between">
            <h4 class="text-primary font-semibold">
              Preview ({{ bulkPreviews().length }} employees)
            </h4>
            <div class="text-right">
              <span class="text-muted text-sm">Total Amount</span>
              <p class="text-success text-xl font-bold">{{ getBulkTotalAmount() | currency }}</p>
            </div>
          </div>

          <p-table
            [value]="bulkPreviews()"
            [tableStyle]="{ 'min-width': '50rem' }"
            [scrollable]="true"
          >
            <ng-template #header>
              <tr>
                <th>Employee</th>
                <th>Role</th>
                <th>Salary Type</th>
                <th class="text-right">Amount</th>
                <th class="text-center">Status</th>
              </tr>
            </ng-template>
            <ng-template #body let-item>
              <tr>
                <td>{{ item.employee.fullName }}</td>
                <td>{{ item.employee.role?.displayName ?? "N/A" }}</td>
                <td>{{ getSalaryTypeDesc(item.employee.salaryType) }}</td>
                <td class="text-right">
                  @if (item.loading) {
                    <i class="pi pi-spin pi-spinner"></i>
                  } @else if (item.error) {
                    <span class="text-danger">Error</span>
                  } @else {
                    {{ item.preview?.total?.amount | currency }}
                  }
                </td>
                <td class="text-center">
                  @if (item.loading) {
                    <i class="pi pi-spin pi-spinner text-primary"></i>
                  } @else if (item.error) {
                    <i class="pi pi-times-circle text-danger" [pTooltip]="item.error"></i>
                  } @else {
                    <i class="pi pi-check-circle text-success"></i>
                  }
                </td>
              </tr>
            </ng-template>
            <ng-template #emptymessage>
              <tr>
                <td colspan="5" class="text-muted text-center">No employees selected</td>
              </tr>
            </ng-template>
          </p-table>
        }

        <div class="mt-6 flex gap-2">
          <p-button
            type="submit"
            icon="pi pi-plus"
            [label]="'Create ' + selectedEmployees().length + ' Payroll(s)'"
            [loading]="isBulkCreating()"
            [disabled]="isBulkCreateDisabled()"
          />
          <p-button
            type="button"
            icon="pi pi-arrow-left"
            label="Back to list"
            [routerLink]="['/payroll/invoices']"
          />
        </div>
      }
    </form>
  </p-card>
</div>
