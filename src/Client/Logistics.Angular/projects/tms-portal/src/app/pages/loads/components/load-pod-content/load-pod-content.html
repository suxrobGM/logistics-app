<!-- Refresh button -->
<div class="mb-4 flex justify-end">
  <p-button
    icon="pi pi-refresh"
    label="Refresh"
    [outlined]="true"
    size="small"
    (click)="refresh()"
    [loading]="isLoading()"
  />
</div>

<!-- Documents List -->
<p-card class="border-default border">
  <ng-template #header>
    <div class="flex items-center gap-2 p-4 pb-0">
      <i class="pi pi-file-check text-primary"></i>
      <h3 class="m-0 text-lg font-semibold">POD / BOL Documents</h3>
      <p-tag [value]="documents().length.toString()" severity="info" />
    </div>
  </ng-template>

  @if (isLoading()) {
    <div class="flex justify-center py-8">
      <p-progress-spinner />
    </div>
  } @else {
    <p-table [value]="documents()" [dataKey]="'id'" [scrollable]="true" class="p-datatable-sm">
      <ng-template #header>
        <tr>
          <th class="w-32">Type</th>
          <th>File Name</th>
          <th class="w-40">Recipient</th>
          <th class="w-40">Location</th>
          <th class="w-40">Captured At</th>
          <th class="w-28">Actions</th>
        </tr>
      </ng-template>

      <ng-template #body let-doc>
        <tr class="hover:bg-hover cursor-pointer" (click)="viewDetails(doc)">
          <td>
            <p-tag
              [value]="getTypeLabel(doc.type)"
              [severity]="getTypeSeverity(doc.type)"
              class="text-xs"
            />
          </td>
          <td>
            <div class="flex flex-col">
              <span class="text-sm font-medium">{{ doc.originalFileName || doc.fileName }}</span>
              <span class="text-muted text-xs">{{ formatFileSize(doc.fileSizeBytes) }}</span>
            </div>
          </td>
          <td>
            @if (doc.recipientName) {
              <div class="flex items-center gap-2">
                <i class="pi pi-user text-muted"></i>
                <span class="text-sm">{{ doc.recipientName }}</span>
              </div>
            } @else {
              <span class="text-muted text-sm">—</span>
            }
          </td>
          <td>
            @if (doc.captureLatitude && doc.captureLongitude) {
              <a
                [href]="getGoogleMapsUrl(doc.captureLatitude, doc.captureLongitude)"
                target="_blank"
                class="text-primary flex items-center gap-1 text-sm hover:underline"
                (click)="$event.stopPropagation()"
              >
                <i class="pi pi-map-marker"></i>
                <span>View on Map</span>
              </a>
            } @else {
              <span class="text-muted text-sm">—</span>
            }
          </td>
          <td>
            @if (doc.capturedAt) {
              <span class="text-sm">{{ doc.capturedAt | date: "medium" }}</span>
            } @else {
              <span class="text-muted text-sm">{{ doc.createdAt | date: "medium" }}</span>
            }
          </td>
          <td>
            <div class="flex gap-1">
              <p-button
                icon="pi pi-eye"
                size="small"
                [text]="true"
                severity="info"
                (click)="viewDetails(doc); $event.stopPropagation()"
                pTooltip="View Details"
              />
              <p-button
                icon="pi pi-download"
                size="small"
                [text]="true"
                severity="success"
                (click)="download(doc); $event.stopPropagation()"
                pTooltip="Download"
              />
            </div>
          </td>
        </tr>
      </ng-template>

      <ng-template #empty>
        <tr>
          <td colspan="6" class="py-8 text-center">
            <div class="text-muted flex flex-col items-center gap-3">
              <i class="pi pi-file-check text-4xl"></i>
              <div>
                <p class="font-medium">No POD/BOL documents found</p>
                <p class="text-sm">Documents will appear here when captured from the Driver App</p>
              </div>
            </div>
          </td>
        </tr>
      </ng-template>
    </p-table>
  }
</p-card>

<!-- Detail Dialog -->
<p-dialog
  header="Document Details"
  [(visible)]="showDetailDialog"
  [modal]="true"
  [style]="{ width: '600px' }"
  [draggable]="false"
  [resizable]="false"
>
  @if (selectedDocument()) {
    <div class="space-y-4">
      <!-- Document Type -->
      <div class="flex items-center justify-between border-b pb-3">
        <p-tag
          [value]="getTypeLabel(selectedDocument()!.type)"
          [severity]="getTypeSeverity(selectedDocument()!.type)"
        />
        <span class="text-muted text-sm">
          {{ selectedDocument()!.capturedAt | date: "medium" }}
        </span>
      </div>

      <!-- File Info -->
      <div class="grid grid-cols-2 gap-4">
        <div>
          <span class="text-muted mb-1 block text-xs font-medium">File Name</span>
          <p class="text-sm">
            {{ selectedDocument()!.originalFileName || selectedDocument()!.fileName }}
          </p>
        </div>
        <div>
          <span class="text-muted mb-1 block text-xs font-medium">File Size</span>
          <p class="text-sm">{{ formatFileSize(selectedDocument()!.fileSizeBytes) }}</p>
        </div>
      </div>

      <!-- Recipient Info -->
      @if (selectedDocument()!.recipientName) {
        <div class="bg-info/10 rounded-lg p-3">
          <span class="text-info mb-1 block text-xs font-medium">Recipient</span>
          <p class="text-sm font-medium">{{ selectedDocument()!.recipientName }}</p>
        </div>
      }

      <!-- Signature Preview -->
      @if (selectedDocument()!.recipientSignature) {
        <div>
          <span class="text-muted mb-2 block text-xs font-medium">Signature</span>
          <div class="bg-surface rounded border p-2">
            @if (
              selectedDocument()!.recipientSignature!.startsWith("data:") ||
              selectedDocument()!.recipientSignature!.length > 100
            ) {
              <img
                [src]="'data:image/png;base64,' + selectedDocument()!.recipientSignature"
                alt="Signature"
                class="max-h-24 w-auto"
              />
            } @else {
              <p class="text-muted text-sm">Signature captured</p>
            }
          </div>
        </div>
      }

      <!-- Location -->
      @if (selectedDocument()!.captureLatitude && selectedDocument()!.captureLongitude) {
        <div class="bg-success/10 rounded-lg p-3">
          <span class="text-success mb-1 block text-xs font-medium">Capture Location</span>
          <div class="flex items-center justify-between">
            <p class="text-sm">
              {{
                formatCoordinates(
                  selectedDocument()!.captureLatitude,
                  selectedDocument()!.captureLongitude
                )
              }}
            </p>
            <a
              [href]="
                getGoogleMapsUrl(
                  selectedDocument()!.captureLatitude,
                  selectedDocument()!.captureLongitude
                )
              "
              target="_blank"
              class="text-primary text-sm hover:underline"
            >
              <i class="pi pi-external-link mr-1"></i>
              Open in Maps
            </a>
          </div>
        </div>
      }

      <!-- Notes -->
      @if (selectedDocument()!.notes) {
        <div>
          <span class="text-muted mb-1 block text-xs font-medium">Notes</span>
          <p class="bg-hover rounded p-2 text-sm">{{ selectedDocument()!.notes }}</p>
        </div>
      }

      <!-- Image Preview -->
      @if (isImage(selectedDocument()!)) {
        <div>
          <span class="text-muted mb-2 block text-xs font-medium">Document Preview</span>
          <div class="bg-hover rounded border p-2">
            <p class="text-muted text-center text-sm">
              <i class="pi pi-image mr-1"></i>
              Image document - click Download to view
            </p>
          </div>
        </div>
      }

      <!-- Actions -->
      <div class="flex justify-end gap-2 border-t pt-4">
        <p-button
          icon="pi pi-download"
          label="Download"
          severity="success"
          (click)="download(selectedDocument()!)"
        />
        <p-button label="Close" [outlined]="true" (click)="showDetailDialog.set(false)" />
      </div>
    </div>
  }
</p-dialog>
