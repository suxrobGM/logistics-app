<div class="animate-fadein">
  <div class="mb-4 flex items-center justify-between">
    <div class="flex items-center">
      <h1 class="text-primary mb-0">Payroll Invoices</h1>
      <p-button
        class="ml-2"
        icon="pi pi-plus-circle"
        size="large"
        [rounded]="true"
        [text]="true"
        pTooltip="Add a new payroll invoice"
        [routerLink]="['/payroll/invoices/add']"
      />
    </div>
    <div class="flex items-center gap-2">
      @if (selectedInvoices().length > 0) {
        <p-button
          icon="pi pi-check-circle"
          label="Approve Selected ({{ selectedInvoices().length }})"
          severity="success"
          [loading]="isBatchApproving()"
          (click)="batchApprove()"
        />
        <p-button icon="pi pi-times" label="Clear" [text]="true" (click)="clearSelection()" />
      }
      <a routerLink="/payroll" class="no-underline">
        <p-button icon="pi pi-chart-bar" label="Dashboard" [outlined]="true" />
      </a>
    </div>
  </div>

  <!-- Filter Panel -->
  <p-card class="mb-4">
    <div class="mb-4 flex items-center justify-between">
      <span class="text-primary text-lg font-semibold">Filters</span>
      <div class="flex items-center gap-2">
        @if (activeFilterCount() > 0) {
          <span class="text-muted text-sm">{{ activeFilterCount() }} active</span>
        }
        <p-button
          label="Clear All"
          icon="pi pi-times"
          size="small"
          [text]="true"
          (click)="clearFilters()"
          [disabled]="activeFilterCount() === 0"
        />
      </div>
    </div>

    <div class="grid grid-cols-1 gap-x-4 md:grid-cols-2 lg:grid-cols-4">
      <ui-labeled-field label="Search Employee">
        <ui-search-input
          class="w-full"
          placeholder="Search by employee name"
          (searchChange)="onSearch($event)"
        />
      </ui-labeled-field>

      <ui-labeled-field label="Status">
        <p-multiselect
          [options]="statusOptions"
          [(ngModel)]="selectedStatuses"
          placeholder="Select status"
          [showClear]="true"
          (onChange)="applyFilters()"
          class="w-full"
        />
      </ui-labeled-field>

      <ui-labeled-field label="Salary Type">
        <p-multiselect
          [options]="salaryTypeOptions"
          [(ngModel)]="selectedSalaryTypes"
          placeholder="Select salary type"
          [showClear]="true"
          (onChange)="applyFilters()"
          class="w-full"
        />
      </ui-labeled-field>

      <ui-labeled-field label="Period Range">
        <p-datepicker
          [(ngModel)]="dateRange"
          selectionMode="range"
          placeholder="Select date range"
          [showIcon]="true"
          (onSelect)="applyFilters()"
          class="w-full"
        />
      </ui-labeled-field>
    </div>

  </p-card>

  <p-card>
    <ui-data-container
      [loading]="store.isLoading()"
      [error]="store.error()"
      [isEmpty]="store.isEmpty()"
      skeletonVariant="table"
      [skeletonRows]="10"
      emptyTitle="No payroll invoices yet"
      emptyMessage="Create your first payroll invoice to get started."
      emptyActionLabel="Add Invoice"
      (retry)="store.retry()"
      (emptyAction)="addInvoice()"
    >
      <p-table
        [value]="store.data()"
        [lazy]="true"
        [paginator]="true"
        [showCurrentPageReport]="true"
        (onLazyLoad)="store.onLazyLoad($event)"
        [rows]="store.pageSize()"
        [first]="store.first()"
        [totalRecords]="store.totalRecords()"
        [loading]="store.isLoading()"
        [rowsPerPageOptions]="[10, 25, 50]"
        [selection]="selectedInvoices()"
        (selectionChange)="onSelectionChange($event)"
        dataKey="id"
      >
        <ng-template #header>
          <tr>
            <th style="width: 3rem">
              @if (hasSelectableInvoices()) {
                <p-tableHeaderCheckbox />
              }
            </th>
            <th pSortableColumn="PeriodStart">
              Period
              <p-sortIcon field="PeriodStart" />
            </th>
            <th pSortableColumn="Employee.FirstName">
              Employee
              <p-sortIcon field="Employee.FirstName" />
            </th>
            <th pSortableColumn="Employee.SalaryType">
              Salary Type
              <p-sortIcon field="Employee.SalaryType" />
            </th>
            <th pSortableColumn="Employee.Salary">
              Employee Salary
              <p-sortIcon field="Employee.Salary" />
            </th>
            <th pSortableColumn="Total">
              Invoice Total
              <p-sortIcon field="Total" />
            </th>
            <th pSortableColumn="Status">
              Status
              <p-sortIcon field="Status" />
            </th>
            <th style="width: 10rem">Actions</th>
          </tr>
        </ng-template>

        <ng-template #body let-invoice>
          <tr>
            <td>
              @if (invoice.status === "pending_approval") {
                <p-tableCheckbox [value]="invoice" />
              }
            </td>
            <td>
              {{ invoice.periodStart | date: "MMM d" }} -
              {{ invoice.periodEnd | date: "mediumDate" }}
            </td>
            <td>{{ invoice.employee?.fullName ?? "-" }}</td>
            <td>{{ getSalaryTypeDesc(invoice.employee?.salaryType) }}</td>
            <td class="text-right">
              @if (invoice.employee?.salaryType === "share_of_gross") {
                {{ invoice.employee?.salary | percent }}
              } @else {
                {{ invoice.employee?.salary | currency }}
              }
            </td>
            <td class="text-right">{{ invoice.total?.amount | currency }}</td>
            <td>
              <app-invoice-status-tag [status]="invoice.status" />
            </td>
            <td>
              <div class="flex items-center gap-1">
                <p-button
                  icon="pi pi-eye"
                  [rounded]="true"
                  [text]="true"
                  pTooltip="View details"
                  tooltipPosition="bottom"
                  [routerLink]="['/payroll/invoices', invoice.id]"
                />
                @if (invoice.status === "pending_approval") {
                  <p-button
                    icon="pi pi-check"
                    [rounded]="true"
                    [text]="true"
                    severity="success"
                    pTooltip="Approve"
                    tooltipPosition="bottom"
                    (click)="approveInvoice(invoice)"
                  />
                  <p-button
                    icon="pi pi-times"
                    [rounded]="true"
                    [text]="true"
                    severity="danger"
                    pTooltip="Reject"
                    tooltipPosition="bottom"
                    (click)="openRejectDialog(invoice)"
                  />
                }
                @if (invoice.status === "draft") {
                  <p-button
                    icon="pi pi-pen-to-square"
                    [rounded]="true"
                    [text]="true"
                    pTooltip="Edit"
                    tooltipPosition="bottom"
                    [routerLink]="['/payroll/invoices', invoice.id, 'edit']"
                  />
                }
              </div>
            </td>
          </tr>
        </ng-template>
      </p-table>
    </ui-data-container>
  </p-card>

  <!-- Reject Dialog -->
  <p-dialog
    header="Reject Payroll"
    [(visible)]="showRejectDialog"
    [modal]="true"
    [style]="{ width: '400px' }"
  >
    <div class="flex flex-col gap-4">
      <p>Please provide a reason for rejecting this payroll invoice.</p>
      <textarea
        pInputTextarea
        [(ngModel)]="rejectionReason"
        rows="3"
        class="w-full"
        placeholder="Enter rejection reason..."
      ></textarea>
    </div>
    <ng-template #footer>
      <p-button label="Cancel" [text]="true" (click)="showRejectDialog.set(false)" />
      <p-button
        label="Reject"
        severity="danger"
        [loading]="isRejecting()"
        (click)="confirmReject()"
      />
    </ng-template>
  </p-dialog>
</div>
