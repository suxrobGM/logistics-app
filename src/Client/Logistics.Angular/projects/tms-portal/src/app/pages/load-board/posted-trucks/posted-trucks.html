<!-- Header -->
<div class="mb-3 flex items-center justify-between">
  <div class="flex items-center gap-3">
    <p-button
      icon="pi pi-arrow-left"
      [rounded]="true"
      [text]="true"
      (onClick)="goBack()"
      pTooltip="Back to Dashboard"
    />
    <ui-page-header
      title="Posted Trucks"
      subtitle="Manage trucks posted to load boards to advertise available capacity"
      [showAddButton]="false"
    />
  </div>
  <p-button
    label="Post Truck"
    icon="pi pi-plus"
    (onClick)="openPostDialog()"
    [disabled]="providers().length === 0"
  />
</div>

<!-- Info Card -->
@if (providers().length === 0) {
  <div class="mb-6">
    <p-card class="bg-warning/10 border-0 shadow-sm">
      <div class="flex items-start gap-3">
        <i class="pi pi-exclamation-triangle text-warning text-2xl"></i>
        <div>
          <h6>No Load Board Providers Configured</h6>
          <p class="text-secondary mb-2 text-sm">
            You need to configure at least one load board provider before you can post trucks.
          </p>
          <p-button
            label="Configure Providers"
            icon="pi pi-cog"
            size="small"
            routerLink="/loadboard/providers"
          />
        </div>
      </div>
    </p-card>
  </div>
} @else {
  <div class="mb-6">
    <p-card class="bg-info/10 border-0 shadow-sm">
      <div class="flex items-start gap-3">
        <i class="pi pi-info-circle text-2xl text-blue-600"></i>
        <div>
          <h6>How Truck Posting Works</h6>
          <p class="text-secondary mb-0 text-sm">
            Post your available trucks to load boards so brokers can find you. Specify where the
            truck is available, where it can go, and when. Posts are automatically refreshed and
            expire after a set period. Remove posts when the truck is no longer available.
          </p>
        </div>
      </div>
    </p-card>
  </div>
}

<!-- Posted Trucks List -->
<p-card class="border-0 shadow-sm">
  <ng-template #header>
    <div class="flex items-center justify-between p-3">
      <div class="flex items-center">
        <i class="pi pi-truck mr-2 text-blue-600"></i>
        <h5 class="mb-0">Your Posted Trucks</h5>
      </div>
      @if (postedTrucks().length > 0) {
        <span class="text-muted text-sm">{{ postedTrucks().length }} trucks posted</span>
      }
    </div>
  </ng-template>

  @if (loading()) {
    <div class="flex justify-center p-5">
      <p-progressSpinner />
    </div>
  } @else if (error()) {
    <div class="p-4 text-center">
      <i class="pi pi-exclamation-circle text-danger mb-3 text-4xl"></i>
      <p class="text-danger">{{ error() }}</p>
      <p-button label="Retry" icon="pi pi-refresh" (onClick)="loadData()" />
    </div>
  } @else if (postedTrucks().length === 0) {
    <div class="p-5 text-center">
      <i class="pi pi-truck text-muted mb-3 text-4xl"></i>
      <p class="text-secondary">No trucks posted to load boards yet.</p>
      <p class="text-muted mb-4 text-sm">
        Post your available trucks to let brokers know you're looking for freight.
      </p>
      @if (providers().length > 0) {
        <p-button label="Post a Truck" icon="pi pi-plus" (onClick)="openPostDialog()" />
      }
    </div>
  } @else {
    <p-table [value]="postedTrucks()" [paginator]="true" [rows]="10">
      <ng-template #header>
        <tr>
          <th>Truck</th>
          <th>Provider</th>
          <th>Available At</th>
          <th>Destination</th>
          <th>Available From</th>
          <th>Equipment</th>
          <th>Status</th>
          <th>Expires</th>
          <th>Actions</th>
        </tr>
      </ng-template>
      <ng-template #body let-truck>
        <tr>
          <td>
            <div class="flex items-center gap-2">
              <i class="pi pi-truck text-blue-600"></i>
              <span class="font-medium">{{ truck.truckNumber || "N/A" }}</span>
            </div>
          </td>
          <td>
            <p-tag [value]="truck.providerName" severity="info" />
          </td>
          <td>
            <div class="text-sm">
              {{ truck.availableAtAddress?.city }}, {{ truck.availableAtAddress?.state }}
            </div>
          </td>
          <td>
            @if (truck.destinationPreference?.city) {
              <div class="text-sm">
                {{ truck.destinationPreference.city }}, {{ truck.destinationPreference.state }}
                @if (truck.destinationRadius) {
                  <span class="text-muted text-xs">({{ truck.destinationRadius }} mi)</span>
                }
              </div>
            } @else {
              <span class="text-muted">Anywhere</span>
            }
          </td>
          <td>
            <span class="text-sm">{{ truck.availableFrom | date: "shortDate" }}</span>
            @if (truck.availableTo) {
              <span class="text-muted text-xs">- {{ truck.availableTo | date: "shortDate" }}</span>
            }
          </td>
          <td>
            <span class="text-sm">{{ truck.equipmentType || "-" }}</span>
          </td>
          <td>
            <p-tag [value]="truck.status" [severity]="getStatusSeverity(truck.status)" />
          </td>
          <td>
            @if (truck.expiresAt) {
              <span class="text-muted text-sm">{{ truck.expiresAt | date: "shortDate" }}</span>
            } @else {
              <span class="text-muted">-</span>
            }
          </td>
          <td>
            <p-button
              icon="pi pi-trash"
              [rounded]="true"
              [text]="true"
              severity="danger"
              pTooltip="Remove Post"
              (onClick)="confirmRemovePost(truck)"
            />
          </td>
        </tr>
      </ng-template>
    </p-table>
  }
</p-card>

<!-- Post Truck Dialog -->
<p-dialog
  header="Post Truck to Load Board"
  [(visible)]="showPostDialog"
  [modal]="true"
  [style]="{ width: '600px' }"
  [draggable]="false"
>
  <form [formGroup]="postForm" (ngSubmit)="postTruck()">
    <div class="grid grid-cols-1 gap-4 md:grid-cols-2">
      <ui-labeled-field
        label="Truck"
        for="truckId"
        [required]="true"
        [control]="postForm.controls.truckId"
      >
        <p-select
          id="truckId"
          formControlName="truckId"
          [options]="trucks()"
          optionLabel="number"
          optionValue="id"
          placeholder="Select truck"
          class="w-full"
          [style]="{ width: '100%' }"
        >
          <ng-template #item let-truck>
            <div>
              <div class="font-medium">{{ truck.number }}</div>
              <small class="text-muted">{{ truck.type }}</small>
            </div>
          </ng-template>
        </p-select>
      </ui-labeled-field>

      <ui-labeled-field
        label="Load Board"
        for="providerType"
        [required]="true"
        [control]="postForm.controls.providerType"
      >
        <p-select
          id="providerType"
          formControlName="providerType"
          [options]="getProviderOptions()"
          optionLabel="label"
          optionValue="value"
          placeholder="Select provider"
          class="w-full"
          [style]="{ width: '100%' }"
        />
      </ui-labeled-field>
    </div>

    <h6 class="mt-4 mb-3">Available Location</h6>
    <div class="grid grid-cols-1 gap-4 md:grid-cols-3">
      <ui-labeled-field
        label="City"
        for="availableAtCity"
        [required]="true"
        [control]="postForm.controls.availableAtCity"
      >
        <input
          pInputText
          id="availableAtCity"
          formControlName="availableAtCity"
          class="w-full"
          placeholder="e.g., Los Angeles"
        />
      </ui-labeled-field>

      <ui-labeled-field
        label="State"
        for="availableAtState"
        [required]="true"
        [control]="postForm.controls.availableAtState"
      >
        <input
          pInputText
          id="availableAtState"
          formControlName="availableAtState"
          class="w-full"
          placeholder="e.g., CA"
        />
      </ui-labeled-field>

      <ui-labeled-field label="ZIP Code" for="availableAtZipCode">
        <input
          pInputText
          id="availableAtZipCode"
          formControlName="availableAtZipCode"
          class="w-full"
          placeholder="e.g., 90001"
        />
      </ui-labeled-field>
    </div>

    <h6 class="mt-4 mb-3">Destination Preference (Optional)</h6>
    <div class="grid grid-cols-1 gap-4 md:grid-cols-3">
      <ui-labeled-field label="City" for="destinationCity">
        <input
          pInputText
          id="destinationCity"
          formControlName="destinationCity"
          class="w-full"
          placeholder="e.g., Dallas"
        />
      </ui-labeled-field>

      <ui-labeled-field label="State" for="destinationState">
        <input
          pInputText
          id="destinationState"
          formControlName="destinationState"
          class="w-full"
          placeholder="e.g., TX"
        />
      </ui-labeled-field>

      <ui-labeled-field label="Radius (mi)" for="destinationRadius">
        <p-inputNumber
          id="destinationRadius"
          formControlName="destinationRadius"
          [min]="0"
          [max]="500"
          class="w-full"
          inputStyleClass="w-full"
        />
      </ui-labeled-field>
    </div>

    <h6 class="mt-4 mb-3">Availability</h6>
    <div class="grid grid-cols-1 gap-4 md:grid-cols-2">
      <ui-labeled-field
        label="Available From"
        for="availableFrom"
        [required]="true"
        [control]="postForm.controls.availableFrom"
      >
        <p-datePicker
          id="availableFrom"
          formControlName="availableFrom"
          [showIcon]="true"
          dateFormat="mm/dd/yy"
          class="w-full"
          inputStyleClass="w-full"
        />
      </ui-labeled-field>

      <ui-labeled-field label="Available To" for="availableTo">
        <p-datePicker
          id="availableTo"
          formControlName="availableTo"
          [showIcon]="true"
          dateFormat="mm/dd/yy"
          class="w-full"
          inputStyleClass="w-full"
        />
      </ui-labeled-field>
    </div>

    <h6 class="mt-4 mb-3">Equipment Details (Optional)</h6>
    <div class="grid grid-cols-1 gap-4 md:grid-cols-3">
      <ui-labeled-field label="Equipment Type" for="equipmentType">
        <p-select
          id="equipmentType"
          formControlName="equipmentType"
          [options]="equipmentOptions"
          optionLabel="label"
          optionValue="value"
          placeholder="Select type"
          class="w-full"
          [style]="{ width: '100%' }"
        />
      </ui-labeled-field>

      <ui-labeled-field label="Max Weight (lbs)" for="maxWeight">
        <p-inputNumber
          id="maxWeight"
          formControlName="maxWeight"
          [min]="0"
          [max]="100000"
          class="w-full"
          inputStyleClass="w-full"
        />
      </ui-labeled-field>

      <ui-labeled-field label="Max Length (ft)" for="maxLength">
        <p-inputNumber
          id="maxLength"
          formControlName="maxLength"
          [min]="0"
          [max]="100"
          class="w-full"
          inputStyleClass="w-full"
        />
      </ui-labeled-field>
    </div>
  </form>

  <ng-template #footer>
    <p-button label="Cancel" (onClick)="showPostDialog.set(false)" [text]="true" />
    <p-button
      label="Post Truck"
      icon="pi pi-check"
      (onClick)="postTruck()"
      [loading]="posting()"
      [disabled]="postForm.invalid"
    />
  </ng-template>
</p-dialog>
