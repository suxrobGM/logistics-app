<ui-page-header title="List Employees" addRoute="/employees/add" addTooltip="Add a new employee" />

<div class="mb-4 flex gap-2">
  <lib-permission-guard [permissions]="Permission.Invitation.Manage">
    <p-button
      icon="pi pi-send"
      label="Invite Employee"
      [outlined]="true"
      (click)="openInviteDialog()"
    />
  </lib-permission-guard>
  <lib-permission-guard [permissions]="Permission.Invitation.View">
    <p-button
      icon="pi pi-clock"
      label="Pending Invitations"
      [outlined]="true"
      routerLink="/employees/invitations"
    />
  </lib-permission-guard>
</div>

<p-card>
  <div class="mb-4">
    <ui-search-input (searchChange)="onSearch($event)" />
  </div>
  <ui-data-container
    [loading]="store.isLoading()"
    [error]="store.error()"
    [isEmpty]="store.isEmpty()"
    skeletonVariant="table"
    [skeletonRows]="10"
    emptyTitle="No employees yet"
    emptyMessage="Add your first employee to get started."
    emptyActionLabel="Add Employee"
    (retry)="store.retry()"
    (emptyAction)="addEmployee()"
  >
    <p-table
      [value]="store.data()"
      [lazy]="true"
      [paginator]="true"
      [showCurrentPageReport]="true"
      (onLazyLoad)="store.onLazyLoad($event)"
      [rows]="store.pageSize()"
      [first]="store.first()"
      [totalRecords]="store.totalRecords()"
      [loading]="store.isLoading()"
      [rowsPerPageOptions]="[10, 25, 50]"
    >
      <ng-template #header>
        <tr>
          <th pSortableColumn="FirstName">
            Name
            <p-sortIcon field="FirstName" />
          </th>
          <th>Status</th>
          <th pSortableColumn="Email">
            Email
            <p-sortIcon field="Email" />
          </th>
          <th pSortableColumn="PhoneNumber">
            Phone
            <p-sortIcon field="PhoneNumber" />
          </th>
          <th>Role</th>
          <th pSortableColumn="Salary">
            Salary
            <p-sortIcon field="Salary" />
          </th>
          <th pSortableColumn="JoinedDate">
            Joined
            <p-sortIcon field="JoinedDate" />
          </th>
          <th></th>
        </tr>
      </ng-template>
      <ng-template #body let-employee>
        <tr class="cursor-pointer hover:bg-hover" (click)="onRowClick(employee)">
          <td>
            <div class="flex items-center gap-3">
              <app-employee-avatar [employee]="employee" size="normal" />
              <div>
                <div class="font-medium">{{ employee.fullName }}</div>
              </div>
            </div>
          </td>
          <td>
            @if (employee.status) {
              <app-employee-status-tag [status]="employee.status" />
            }
          </td>
          <td>{{ employee.email }}</td>
          <td>{{ employee.phoneNumber || '-' }}</td>
          <td>
            @if (employee.role) {
              <p-tag [value]="employee.role.displayName" [severity]="getRoleSeverity(employee.role.name)" />
            } @else {
              <span class="text-muted">-</span>
            }
          </td>
          <td>
            @if (employee.salaryType === "share_of_gross") {
              {{ employee.salary | percent }}
            } @else if (employee.salaryType === "hourly") {
              {{ employee.salary | currency }}/hr
            } @else if (employee.salaryType === "rate_per_mile") {
              {{ employee.salary | currency }}/mi
            } @else if (employee.salaryType === "rate_per_kilometer") {
              {{ employee.salary | currency }}/km
            } @else {
              {{ employee.salary | currency }}
            }
          </td>
          <td>{{ employee.joinedDate | date: "mediumDate" }}</td>
          <td>
            <p-button
              icon="pi pi-ellipsis-v"
              [text]="true"
              aria-label="Show actions menu"
              (click)="$event.stopPropagation(); selectedRow.set(employee); menu.toggle($event)"
            />
          </td>
        </tr>
      </ng-template>
    </p-table>
  </ui-data-container>
</p-card>

<app-invite-employee-dialog
  [(visible)]="inviteDialogVisible"
  (invitationSent)="onInvitationSent()"
/>

<!-- Context menu for row actions -->
<p-menu #menu [model]="actionMenuItems" [popup]="true" />
