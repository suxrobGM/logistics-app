<ui-page-header title="Pending Invitations">
  <p-button icon="pi pi-plus" label="Invite Employee" (click)="openInviteDialog()" />
</ui-page-header>

<p-card>
  <ui-data-container
    [loading]="store.isLoading()"
    [error]="store.error()"
    [isEmpty]="store.isEmpty()"
    skeletonVariant="table"
    [skeletonRows]="10"
    emptyTitle="No pending invitations"
    emptyMessage="All invitations have been accepted or there are none sent yet."
    emptyActionLabel="Invite Employee"
    (retry)="store.retry()"
    (emptyAction)="openInviteDialog()"
  >
    <p-table
      [value]="store.data()"
      [lazy]="true"
      [paginator]="true"
      [showCurrentPageReport]="true"
      (onLazyLoad)="store.onLazyLoad($event)"
      [rows]="store.pageSize()"
      [first]="store.first()"
      [totalRecords]="store.totalRecords()"
      [loading]="store.isLoading()"
      [rowsPerPageOptions]="[10, 25, 50]"
    >
      <ng-template #caption>
        <ui-search-input (searchChange)="onSearch($event)" />
      </ng-template>
      <ng-template #header>
        <tr>
          <th pSortableColumn="Email">
            Email
            <p-sortIcon field="Email" />
          </th>
          <th>Type</th>
          <th>Role</th>
          <th pSortableColumn="CreatedDate">
            Sent
            <p-sortIcon field="CreatedDate" />
          </th>
          <th pSortableColumn="ExpiresAt">
            Expires
            <p-sortIcon field="ExpiresAt" />
          </th>
          <th>Invited By</th>
          <th>Actions</th>
        </tr>
      </ng-template>
      <ng-template #body let-invitation>
        <tr>
          <td>{{ invitation.email }}</td>
          <td>
            <p-tag
              [value]="invitation.type === 'Employee' ? 'Employee' : 'Customer'"
              [severity]="getInvitationTypeSeverity(invitation.type)"
            />
          </td>
          <td>{{ invitation.roleDisplayName }}</td>
          <td>{{ invitation.createdDate | date: "mediumDate" }}</td>
          <td>
            @if (isExpiringSoon(invitation.expiresAt)) {
              <span class="font-medium text-orange-500">
                {{ invitation.expiresAt | date: "short" }}
                <i class="pi pi-exclamation-triangle ml-1" pTooltip="Expiring soon"></i>
              </span>
            } @else {
              {{ invitation.expiresAt | date: "short" }}
            }
          </td>
          <td>{{ invitation.invitedByName }}</td>
          <td class="overflow-visible">
            <p-button
              icon="pi pi-refresh"
              pTooltip="Resend invitation"
              tooltipPosition="bottom"
              [text]="true"
              (click)="resendInvitation(invitation.id)"
            />
            <p-button
              icon="pi pi-times"
              pTooltip="Cancel invitation"
              tooltipPosition="bottom"
              [text]="true"
              severity="danger"
              (click)="cancelInvitation(invitation.id)"
            />
          </td>
        </tr>
      </ng-template>
    </p-table>
  </ui-data-container>
</p-card>

<app-invite-employee-dialog
  [(visible)]="inviteDialogVisible"
  (invitationSent)="onInvitationSent()"
/>

<p-confirmDialog />
