<div class="w-full p-6">
  <!-- Header -->
  <div class="mb-6 flex items-center justify-between">
    <div class="flex items-center gap-4">
      <p-button
        icon="pi pi-arrow-left"
        [rounded]="true"
        [text]="true"
        (onClick)="goBack()"
        pTooltip="Back to Dashboard"
        aria-label="Go back to dashboard"
      />
      <div>
        <h1 class="mb-1 text-2xl font-semibold">ELD Provider Configuration</h1>
        <p class="text-muted mb-0">Connect your ELD devices to sync driver Hours of Service data</p>
      </div>
    </div>
    <p-button label="Add Provider" icon="pi pi-plus" (onClick)="openAddDialog()" />
  </div>

  <!-- Info Card -->
  <div class="mb-6">
    <p-card class="border-0 bg-blue-500/10 shadow-sm">
      <div class="flex items-start gap-3">
        <i class="pi pi-info-circle text-2xl text-blue-600"></i>
        <div>
          <h6 class="mb-1 font-medium">How ELD Integration Works</h6>
          <p class="text-secondary mb-0 text-sm">
            Connect your ELD provider to automatically sync driver Hours of Service (HOS) data.
            After adding a provider, you'll need to map your TMS drivers to the ELD system drivers.
            The system will then sync HOS data every 5 minutes and receive real-time updates via
            webhooks.
          </p>
        </div>
      </div>
    </p-card>
  </div>

  <!-- Providers List -->
  <p-card class="border-0 shadow-sm">
    <ng-template pTemplate="header">
      <div class="flex items-center p-3">
        <i class="pi pi-cog mr-2 text-blue-600"></i>
        <h5 class="mb-0">Configured Providers</h5>
      </div>
    </ng-template>

    @if (loading()) {
      <div class="flex justify-center p-5">
        <p-progressSpinner />
      </div>
    } @else if (error()) {
      <div class="p-4 text-center">
        <i class="pi pi-exclamation-circle mb-3 text-4xl text-red-500"></i>
        <p class="text-red-500">{{ error() }}</p>
        <p-button label="Retry" icon="pi pi-refresh" (onClick)="loadProviders()" />
      </div>
    } @else if (providers().length === 0) {
      <div class="p-5 text-center">
        <i class="pi pi-link text-muted mb-3 text-4xl"></i>
        <p class="text-secondary">No ELD providers configured yet.</p>
        <p class="text-muted mb-4 text-sm">
          Add your first ELD provider to start syncing driver HOS data.
        </p>
        <p-button label="Add Provider" icon="pi pi-plus" (onClick)="openAddDialog()" />
      </div>
    } @else {
      <p-table [value]="providers()">
        <ng-template pTemplate="header">
          <tr>
            <th>Provider</th>
            <th>Status</th>
            <th>Mapped Drivers</th>
            <th>Mapped Vehicles</th>
            <th>Last Synced</th>
            <th>Actions</th>
          </tr>
        </ng-template>
        <ng-template pTemplate="body" let-provider>
          <tr>
            <td>
              <div class="flex items-center gap-3">
                <div class="flex h-10 w-10 items-center justify-center rounded-full bg-blue-600/10">
                  <i class="pi pi-link text-blue-600"></i>
                </div>
                <div>
                  <div class="font-medium">{{ getProviderLabel(provider.providerType) }}</div>
                  <small class="text-muted">{{
                    provider.providerName || provider.providerType
                  }}</small>
                </div>
              </div>
            </td>
            <td>
              @if (provider.isConnected) {
                <p-tag value="Connected" severity="success"></p-tag>
              } @else {
                <p-tag value="Disconnected" severity="danger"></p-tag>
              }
            </td>
            <td>
              <span class="bg-hover rounded px-2 py-1 text-sm">{{
                provider.mappedDriversCount || 0
              }}</span>
            </td>
            <td>
              <span class="bg-hover rounded px-2 py-1 text-sm">{{
                provider.mappedVehiclesCount || 0
              }}</span>
            </td>
            <td>
              @if (provider.lastSyncedAt) {
                <span class="text-muted text-sm">{{ provider.lastSyncedAt | date: "short" }}</span>
              } @else {
                <span class="text-muted text-sm">Never</span>
              }
            </td>
            <td>
              <div class="flex gap-1">
                <p-button
                  icon="pi pi-users"
                  [rounded]="true"
                  [text]="true"
                  pTooltip="Manage Driver Mappings"
                  aria-label="Manage driver mappings"
                  (onClick)="manageDriverMappings(provider.id!)"
                />
                <p-button
                  icon="pi pi-trash"
                  [rounded]="true"
                  [text]="true"
                  severity="danger"
                  pTooltip="Delete Provider"
                  aria-label="Delete provider"
                  (onClick)="confirmDeleteProvider(provider)"
                />
              </div>
            </td>
          </tr>
        </ng-template>
      </p-table>
    }
  </p-card>
</div>

<!-- Add Provider Dialog -->
<p-dialog
  header="Add ELD Provider"
  [(visible)]="showAddDialog"
  [modal]="true"
  [style]="{ width: '500px' }"
  [draggable]="false"
>
  <form [formGroup]="addForm" (ngSubmit)="saveProvider()">
    <ui-labeled-field
      label="Provider"
      for="providerType"
      [required]="true"
      [control]="addForm.controls.providerType"
    >
      <p-select
        id="providerType"
        formControlName="providerType"
        [options]="providerOptions"
        optionLabel="label"
        optionValue="value"
        placeholder="Select provider"
        class="w-full"
        [style]="{ width: '100%' }"
      >
        <ng-template pTemplate="item" let-item>
          <div>
            <div class="font-medium">{{ item.label }}</div>
            <small class="text-muted">{{ item.description }}</small>
          </div>
        </ng-template>
      </p-select>
    </ui-labeled-field>

    <ui-labeled-field
      label="API Key"
      for="apiKey"
      [required]="true"
      hint="Your ELD provider API key or access token"
      [control]="addForm.controls.apiKey"
    >
      <input
        pInputText
        id="apiKey"
        formControlName="apiKey"
        class="w-full"
        placeholder="Enter API key"
      />
    </ui-labeled-field>

    <ui-labeled-field
      label="API Secret (Optional)"
      for="apiSecret"
      hint="Required for some providers"
    >
      <p-password
        id="apiSecret"
        formControlName="apiSecret"
        [toggleMask]="true"
        [feedback]="false"
        class="w-full"
        inputStyleClass="w-full"
        placeholder="Enter API secret"
      />
    </ui-labeled-field>

    <ui-labeled-field
      label="Webhook Secret (Optional)"
      for="webhookSecret"
      hint="For verifying incoming webhook requests"
    >
      <p-password
        id="webhookSecret"
        formControlName="webhookSecret"
        [toggleMask]="true"
        [feedback]="false"
        class="w-full"
        inputStyleClass="w-full"
        placeholder="Enter webhook secret"
      />
    </ui-labeled-field>

    <div class="rounded bg-yellow-500/10 p-3">
      <div class="flex items-start gap-2">
        <i class="pi pi-exclamation-triangle text-yellow-600"></i>
        <div class="text-sm">
          <strong>Where to get credentials:</strong>
          <ul class="text-secondary mt-1 mb-0 list-inside list-disc">
            <li>Demo: Enter any text as API key (for testing only)</li>
            <li>Samsara: Settings → API Tokens in your Samsara dashboard</li>
            <li>Motive: Settings → Integrations → API Keys</li>
          </ul>
        </div>
      </div>
    </div>
  </form>

  <ng-template pTemplate="footer">
    <p-button label="Cancel" (onClick)="showAddDialog.set(false)" [text]="true" />
    <p-button
      label="Add Provider"
      icon="pi pi-check"
      (onClick)="saveProvider()"
      [loading]="saving()"
      [disabled]="addForm.invalid"
    />
  </ng-template>
</p-dialog>
