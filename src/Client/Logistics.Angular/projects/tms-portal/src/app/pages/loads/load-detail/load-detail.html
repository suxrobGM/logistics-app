<!-- Header with actions -->
<div class="mb-6 flex items-start justify-between">
  <ui-page-header title="Load Details" [showAddButton]="false" />
  <div class="flex gap-2">
    <p-button icon="pi pi-link" label="Tracking Link" [outlined]="true" (click)="showTrackingDialog.set(true)" />
    <p-button icon="pi pi-pencil" label="Edit" [outlined]="true" (click)="onEdit()" />
    <p-button icon="pi pi-arrow-left" label="Back" [routerLink]="['/loads']" [outlined]="true" />
  </div>
</div>

@if (isLoading()) {
  <div class="flex justify-center py-16">
    <p-progress-spinner />
  </div>
} @else if (load()) {
  <p-card>
    <p-tabs [value]="activeTab()" (valueChange)="onTabChange($event)">
      <p-tablist>
        <p-tab [value]="0">
          <i class="pi pi-info-circle mr-2"></i>
          Details
        </p-tab>
        <p-tab [value]="1">
          <i class="pi pi-folder mr-2"></i>
          Documents
        </p-tab>
        <p-tab [value]="2">
          <i class="pi pi-file-check mr-2"></i>
          POD / BOL
        </p-tab>
        <p-tab [value]="3">
          <i class="pi pi-book mr-2"></i>
          Invoices
        </p-tab>
      </p-tablist>

      <p-tabpanels>
        <!-- Details Tab -->
        <p-tabpanel [value]="0">
          <div class="grid grid-cols-1 gap-6 pt-4 lg:grid-cols-2">
            <!-- Load Info Card -->
            <p-card class="border-default border">
              <ng-template #header>
                <div class="p-4 pb-0">
                  <h3 class="m-0 text-lg font-semibold">Load Information</h3>
                </div>
              </ng-template>

              <div class="space-y-4">
                <div class="flex items-center justify-between">
                  <span>Load #</span>
                  <span class="font-mono font-semibold">{{ load()!.number }}</span>
                </div>

                @if (load()!.name) {
                  <div class="flex items-center justify-between">
                    <span>Name</span>
                    <span class="font-medium">{{ load()!.name }}</span>
                  </div>
                }

                <p-divider />

                <div class="flex items-center justify-between">
                  <span>Type</span>
                  <app-load-type-tag [type]="load()!.type!" />
                </div>

                <div class="flex items-center justify-between">
                  <span>Status</span>
                  <app-load-status-tag [status]="load()!.status!" />
                </div>

                <p-divider />

                <div class="flex items-center justify-between">
                  <span>Delivery Cost</span>
                  <span class="text-success text-xl font-bold">
                    {{ load()!.deliveryCost | currency }}
                  </span>
                </div>

                @if (load()!.distance) {
                  <div class="flex items-center justify-between">
                    <span>Distance</span>
                    <span>{{ load()!.distance | distanceUnit: "mi" }}</span>
                  </div>
                }
              </div>
            </p-card>

            <!-- Assignment Card -->
            <p-card class="border-default border">
              <ng-template #header>
                <div class="p-4 pb-0">
                  <h3 class="m-0 text-lg font-semibold">Assignment</h3>
                </div>
              </ng-template>

              <div class="space-y-4">
                @if (load()!.customer) {
                  <div class="flex items-center justify-between">
                    <span>Customer</span>
                    <a
                      [routerLink]="['/customers', load()!.customer!.id]"
                      class="text-primary font-medium hover:underline"
                    >
                      {{ load()!.customer!.name }}
                    </a>
                  </div>
                }

                <p-divider />

                @if (load()!.assignedTruckNumber) {
                  <div class="flex items-center justify-between">
                    <span>Truck</span>
                    <a
                      [routerLink]="['/trucks', load()!.assignedTruckId]"
                      class="text-primary font-medium hover:underline"
                    >
                      {{ load()!.assignedTruckNumber }}
                    </a>
                  </div>
                }

                @if (load()!.assignedTruckDriversName?.length) {
                  <div class="flex items-center justify-between">
                    <span>Driver(s)</span>
                    <span>{{ load()!.assignedTruckDriversName!.join(", ") }}</span>
                  </div>
                }

                @if (load()!.assignedDispatcherName) {
                  <div class="flex items-center justify-between">
                    <span>Dispatcher</span>
                    <span>{{ load()!.assignedDispatcherName }}</span>
                  </div>
                }

                @if (load()!.tripId) {
                  <p-divider />
                  <div class="flex items-center justify-between">
                    <span>Trip</span>
                    <a
                      [routerLink]="['/trips', load()!.tripId]"
                      class="text-primary font-medium hover:underline"
                    >
                      {{ load()!.tripName }}
                    </a>
                  </div>
                }
              </div>
            </p-card>
          </div>

          <!-- Route Card (full width) -->
          <p-card class="border-default mt-6 border">
            <ng-template #header>
              <div class="p-4 pb-0">
                <h3 class="m-0 text-lg font-semibold">Route Information</h3>
              </div>
            </ng-template>

            <div class="grid grid-cols-1 gap-6 md:grid-cols-2">
              <div>
                <div class="mb-2 flex items-center gap-2">
                  <i class="pi pi-map-marker text-blue-500"></i>
                  <span class="text-info font-medium">Origin</span>
                </div>
                <p class="text-secondary">{{ load()!.originAddress | address }}</p>
              </div>
              <div>
                <div class="mb-2 flex items-center gap-2">
                  <i class="pi pi-flag text-green-500"></i>
                  <span class="text-success font-medium">Destination</span>
                </div>
                <p class="text-secondary">{{ load()!.destinationAddress | address }}</p>
              </div>
            </div>

            @if (load()!.currentAddress) {
              <p-divider />
              <div>
                <div class="mb-2 flex items-center gap-2">
                  <i class="pi pi-truck text-orange-500"></i>
                  <span class="text-warning font-medium">Current Location</span>
                </div>
                <p class="text-secondary">{{ load()!.currentAddress | address }}</p>
              </div>
            }
          </p-card>

          <!-- Timeline Card -->
          <p-card class="border-default mt-6 border">
            <ng-template #header>
              <div class="p-4 pb-0">
                <h3 class="m-0 text-lg font-semibold">Timeline</h3>
              </div>
            </ng-template>

            <div class="grid grid-cols-2 gap-4 md:grid-cols-4">
              <div>
                <span class="text-muted block text-sm">Created</span>
                <span class="font-medium">{{ load()!.createdAt | date: "medium" }}</span>
              </div>
              @if (load()!.dispatchedAt) {
                <div>
                  <span class="text-muted block text-sm">Dispatched</span>
                  <span class="font-medium">{{ load()!.dispatchedAt | date: "medium" }}</span>
                </div>
              }
              @if (load()!.pickedUpAt) {
                <div>
                  <span class="text-muted block text-sm">Picked Up</span>
                  <span class="font-medium">{{ load()!.pickedUpAt | date: "medium" }}</span>
                </div>
              }
              @if (load()!.deliveredAt) {
                <div>
                  <span class="text-muted block text-sm">Delivered</span>
                  <span class="text-success font-medium">
                    {{ load()!.deliveredAt | date: "medium" }}
                  </span>
                </div>
              }
              @if (load()!.cancelledAt) {
                <div>
                  <span class="text-muted block text-sm">Cancelled</span>
                  <span class="text-danger font-medium">
                    {{ load()!.cancelledAt | date: "medium" }}
                  </span>
                </div>
              }
            </div>
          </p-card>
        </p-tabpanel>

        <!-- Documents Tab -->
        <p-tabpanel [value]="1">
          <div class="pt-4">
            <app-document-manager [loadId]="id()" [types]="loadDocTypes" />
          </div>
        </p-tabpanel>

        <!-- POD/BOL Tab -->
        <p-tabpanel [value]="2">
          <div class="pt-4">
            <app-load-pod-content [loadId]="id()" />
          </div>
        </p-tabpanel>

        <!-- Invoices Tab -->
        <p-tabpanel [value]="3">
          <div class="pt-4">
            <app-load-invoices-content [loadId]="id()" />
          </div>
        </p-tabpanel>
      </p-tabpanels>
    </p-tabs>
  </p-card>

  <!-- Tracking Link Dialog -->
  <app-tracking-link-dialog [loadId]="id()" [(visible)]="showTrackingDialog" />
} @else {
  <p-card>
    <div class="py-16 text-center">
      <i class="pi pi-exclamation-circle text-muted mb-4 text-4xl"></i>
      <p class="text-muted">Load not found</p>
      <p-button label="Back to Loads" [routerLink]="['/loads']" class="mt-4" />
    </div>
  </p-card>
}
