<div class="animate-fadein">
  <!-- Page Header -->
  <div class="mb-6 flex items-center justify-between">
    <div>
      <h1 class="mb-1 text-2xl font-semibold">{{ greeting() }}</h1>
      <p class="text-muted">{{ currentDate | dateFormat: "EEEE, MMMM d, yyyy" }}</p>
    </div>
    <div class="flex items-center gap-3">
      <!-- Data Freshness Indicator -->
      <div class="text-muted flex items-center gap-2 text-sm">
        <span>Updated {{ lastUpdated() | dateFormat: "shortTime" }}</span>
        <p-button
          icon="pi pi-refresh"
          [rounded]="true"
          [text]="true"
          severity="secondary"
          (click)="refreshData()"
          pTooltip="Refresh data"
          tooltipPosition="bottom"
        />
      </div>
      <p-button
        icon="pi pi-th-large"
        [rounded]="true"
        [text]="true"
        severity="secondary"
        (click)="resetLayout()"
        pTooltip="Reset Layout"
        tooltipPosition="bottom"
      />
      <p-button
        label="Quick Actions"
        icon="pi pi-plus"
        [outlined]="true"
        (click)="menu.toggle($event)"
      />
      <p-menu #menu [model]="quickActions" [popup]="true" />
    </div>
  </div>

  <!-- Gridster Dashboard -->
  @if (gridsterOptions) {
    <gridster [options]="gridsterOptions" class="dashboard-grid">
      @for (panel of dashboardPanels(); track panel.id) {
        <gridster-item [item]="panel" class="dashboard-panel">
          @switch (panel.id) {
            @case ("kpi-weekly-gross") {
              <ui-stat-card
                class="h-full"
                icon="pi-dollar"
                label="Weekly Gross"
                [value]="(weeklyGross() | currencyFormat) ?? '$0'"
                color="green"
              />
            }
            @case ("kpi-billed-miles") {
              <ui-stat-card
                class="h-full"
                icon="pi-map"
                label="Billed Miles"
                [value]="(weeklyDistance() | distanceUnit) ?? '0 mi'"
                color="blue"
              />
            }
            @case ("kpi-rate-per-mile") {
              <ui-stat-card
                class="h-full"
                icon="pi-chart-line"
                label="Rate Per Mile"
                [value]="(weeklyRpm() | currencyFormat) ?? '$0'"
                color="purple"
              />
            }
            @case ("kpi-today-gross") {
              <ui-stat-card
                class="h-full"
                icon="pi-calendar"
                label="Today's Gross"
                [value]="(todayGross() | currencyFormat) ?? '$0'"
                color="orange"
              />
            }
            @case ("active-loads") {
              <p-card class="h-full">
                <ng-template #header>
                  <div class="flex items-center justify-between py-3 pr-2 pl-4">
                    <div class="flex items-center gap-2">
                      <i class="pi pi-box text-accent"></i>
                      <h4 class="mb-0">Active Loads</h4>
                    </div>
                    <p-button
                      label="View All"
                      [text]="true"
                      [routerLink]="['/loads']"
                      class="no-drag"
                    />
                  </div>
                  <p-divider class="m-0" />
                </ng-template>

                <p-table
                  [value]="loads()"
                  [loading]="isLoadingLoadsData()"
                  [scrollable]="true"
                  scrollHeight="flex"
                  class="no-drag"
                >
                  <ng-template #header>
                    <tr>
                      <th>Load</th>
                      <th>Status</th>
                      <th>Route</th>
                      <th>Progress</th>
                      <th>Truck</th>
                    </tr>
                  </ng-template>
                  <ng-template #body let-load>
                    <tr>
                      <td>
                        <a
                          [routerLink]="['/loads', load.id, 'edit']"
                          class="text-primary font-semibold"
                        >
                          #{{ load.number }}
                        </a>
                      </td>
                      <td>
                        <p-badge
                          [value]="getStatusLabel(load.status)"
                          [severity]="getStatusSeverity(load.status)"
                        />
                      </td>
                      <td>
                        <div class="flex items-center gap-1 text-sm">
                          <span class="max-w-20 truncate" [pTooltip]="load.originAddress?.city">
                            {{ load.originAddress?.city || "N/A" }}
                          </span>
                          <i class="pi pi-arrow-right text-muted text-xs"></i>
                          <span
                            class="max-w-20 truncate"
                            [pTooltip]="load.destinationAddress?.city"
                          >
                            {{ load.destinationAddress?.city || "N/A" }}
                          </span>
                        </div>
                      </td>
                      <td class="min-w-32">
                        <app-load-progress-bar [status]="load.status" [compact]="true" />
                      </td>
                      <td>
                        @if (load.assignedTruckId) {
                          <a [routerLink]="['/trucks', load.assignedTruckId]" class="text-primary">
                            {{ load.assignedTruckNumber }}
                          </a>
                        } @else {
                          <span class="text-muted">Unassigned</span>
                        }
                      </td>
                    </tr>
                  </ng-template>
                  <ng-template #emptymessage>
                    <tr>
                      <td colspan="5" class="text-center">
                        <div class="text-muted py-8">
                          <i class="pi pi-inbox mb-2 text-4xl"></i>
                          <p>No active loads</p>
                        </div>
                      </td>
                    </tr>
                  </ng-template>
                </p-table>
              </p-card>
            }
            @case ("recent-activity") {
              <app-recent-activity
                class="h-full"
                [loads]="recentLoads()"
                [isLoading]="isLoadingLoadsData()"
              />
            }
            @case ("fleet-map") {
              <p-card class="h-full">
                <ng-template #header>
                  <div class="flex items-center gap-2 py-3 pr-2 pl-4">
                    <i class="pi pi-map-marker text-accent"></i>
                    <h4 class="mb-0">Fleet Overview</h4>
                  </div>

                  <p-divider class="m-0" />
                </ng-template>
                <div class="no-drag h-full">
                  <app-trucks-map height="100%" />
                </div>
              </p-card>
            }
            @case ("daily-gross-chart") {
              <app-daily-gross-chart
                chartClass="no-drag"
                (dataLoaded)="onChartDataLoaded($event)"
              />
            }
          }
        </gridster-item>
      }
    </gridster>
  }
</div>
