<!-- Header -->
<div class="flex items-center justify-between">
  <ui-page-header
    title="Safety Report"
    subtitle="DVIR, accidents, and driver behavior metrics"
    [showAddButton]="false"
  />
  <ui-date-range-picker (datesChange)="onDateRangeChange($event)" />
</div>

@if (isLoading()) {
  <!-- Loading State -->
  <div class="grid grid-cols-12">
    @for (item of [1, 2, 3, 4]; track item) {
      <div class="col-span-12 mb-6 md:col-span-6 lg:col-span-3">
        <p-skeleton height="120px"></p-skeleton>
      </div>
    }
  </div>
} @else {
  <!-- Key Safety Metrics Cards -->
  <div class="mb-6 grid grid-cols-12 gap-2">
    <div class="col-span-12 mb-4 md:col-span-6 lg:col-span-3">
      <ui-stat-card
        icon="pi-file-edit"
        label="Total DVIRs"
        [value]="(data()?.totalDvirs || 0).toString()"
        color="blue"
        [trend]="(data()?.pendingDvirReviews || 0) + ' pending review'"
      />
    </div>

    <div class="col-span-12 mb-4 md:col-span-6 lg:col-span-3">
      <ui-stat-card
        icon="pi-car"
        label="Accidents"
        [value]="(data()?.totalAccidents || 0).toString()"
        color="red"
        [trend]="(data()?.unresolvedAccidents || 0) + ' unresolved'"
      />
    </div>

    <div class="col-span-12 mb-4 md:col-span-6 lg:col-span-3">
      <ui-stat-card
        icon="pi-dollar"
        label="Estimated Damage"
        [value]="(data()?.estimatedDamageCost || 0 | currency: 'USD' : 'symbol' : '1.0-0') ?? '$0'"
        color="orange"
        [trend]="(data()?.injuriesReported || 0) + ' injuries'"
      />
    </div>

    <div class="col-span-12 mb-4 md:col-span-6 lg:col-span-3">
      <ui-stat-card
        icon="pi-exclamation-triangle"
        label="Behavior Events"
        [value]="(data()?.totalBehaviorEvents || 0).toString()"
        color="orange"
        [trend]="(data()?.unreviewedBehaviorEvents || 0) + ' unreviewed'"
      />
    </div>
  </div>

  <!-- Charts Row 1 -->
  <div class="mb-6 grid grid-cols-12 gap-2">
    <div class="col-span-12 mb-6 lg:col-span-4">
      <ui-dashboard-card title="DVIR Status" icon="pi-chart-pie" iconColor="blue">
        @if (hasDvirStatusData()) {
          <p-chart
            type="doughnut"
            [data]="dvirStatusChartData()"
            [options]="pieChartOptions"
            style="height: 280px"
          />
        } @else {
          <div class="text-muted flex h-70 items-center justify-center">
            <span>No DVIR data available</span>
          </div>
        }
      </ui-dashboard-card>
    </div>

    <div class="col-span-12 mb-6 lg:col-span-4">
      <ui-dashboard-card title="Accident Severity" icon="pi-chart-pie" iconColor="red">
        @if (hasAccidentSeverityData()) {
          <p-chart
            type="doughnut"
            [data]="accidentSeverityChartData()"
            [options]="pieChartOptions"
            style="height: 280px"
          />
        } @else {
          <div class="text-muted flex h-70 items-center justify-center">
            <span>No accident data available</span>
          </div>
        }
      </ui-dashboard-card>
    </div>

    <div class="col-span-12 mb-6 lg:col-span-4">
      <ui-dashboard-card title="Behavior Events by Type" icon="pi-chart-bar" iconColor="orange">
        @if (hasBehaviorEventData()) {
          <p-chart
            type="bar"
            [data]="behaviorEventChartData()"
            [options]="barChartOptions"
            style="height: 280px"
          />
        } @else {
          <div class="text-muted flex h-70 items-center justify-center">
            <span>No behavior event data available</span>
          </div>
        }
      </ui-dashboard-card>
    </div>
  </div>

  <!-- Safety Trends Chart -->
  <div class="mb-6 grid grid-cols-12 gap-2">
    <div class="col-span-12">
      <ui-dashboard-card title="Safety Trends" icon="pi-chart-line" iconColor="blue">
        @if (hasTrendData()) {
          <p-chart
            type="line"
            [data]="trendChartData()"
            [options]="trendChartOptions"
            style="height: 350px"
          />
        } @else {
          <div class="text-muted flex h-88 items-center justify-center">
            <span>No trend data available</span>
          </div>
        }
      </ui-dashboard-card>
    </div>
  </div>

  <!-- Data Tables -->
  <div class="grid grid-cols-12 gap-2">
    <div class="col-span-12 mb-6 lg:col-span-6">
      <ui-dashboard-card title="Top Drivers by Events" icon="pi-users" iconColor="orange">
        <p-table [value]="data()?.topDriversByEvents || []" [paginator]="true" [rows]="5">
          <ng-template #header>
            <tr>
              <th>Driver</th>
              <th class="text-right">Behavior Events</th>
              <th class="text-right">Accidents</th>
            </tr>
          </ng-template>
          <ng-template #body let-driver>
            <tr>
              <td>
                <a
                  [routerLink]="['/employees', driver.driverId]"
                  class="flex items-center no-underline hover:underline"
                >
                  <div
                    class="mr-2 flex h-8 w-8 items-center justify-center rounded-full bg-amber-600/10"
                  >
                    <span class="text-xs font-medium text-amber-600">{{
                      getDriverInitials(driver.driverName)
                    }}</span>
                  </div>
                  <span class="font-medium">{{ driver.driverName }}</span>
                </a>
              </td>
              <td class="text-right">
                <span class="bg-amber-600/10 rounded px-2 py-1 text-sm text-amber-600">{{
                  driver.behaviorEventCount
                }}</span>
              </td>
              <td class="text-right">
                <span class="bg-red-600/10 rounded px-2 py-1 text-sm text-red-600">{{
                  driver.accidentCount
                }}</span>
              </td>
            </tr>
          </ng-template>
          <ng-template #emptymessage>
            <tr>
              <td colspan="3" class="text-muted text-center">No driver data available</td>
            </tr>
          </ng-template>
        </p-table>
      </ui-dashboard-card>
    </div>

    <div class="col-span-12 mb-6 lg:col-span-6">
      <ui-dashboard-card title="Top Trucks by Defects" icon="pi-truck" iconColor="blue">
        <p-table [value]="data()?.topTrucksByDefects || []" [paginator]="true" [rows]="5">
          <ng-template #header>
            <tr>
              <th>Truck</th>
              <th class="text-right">Defects</th>
              <th class="text-right">Accidents</th>
            </tr>
          </ng-template>
          <ng-template #body let-truck>
            <tr>
              <td>
                <a
                  [routerLink]="['/fleet/trucks', truck.truckId]"
                  class="flex items-center no-underline hover:underline"
                >
                  <div
                    class="mr-2 flex h-8 w-8 items-center justify-center rounded-full bg-blue-600/10"
                  >
                    <i class="pi pi-truck text-sm text-blue-600"></i>
                  </div>
                  <span class="font-medium">{{ truck.truckNumber }}</span>
                </a>
              </td>
              <td class="text-right">
                <span class="bg-blue-600/10 rounded px-2 py-1 text-sm text-blue-600">{{
                  truck.defectCount
                }}</span>
              </td>
              <td class="text-right">
                <span class="bg-red-600/10 rounded px-2 py-1 text-sm text-red-600">{{
                  truck.accidentCount
                }}</span>
              </td>
            </tr>
          </ng-template>
          <ng-template #emptymessage>
            <tr>
              <td colspan="3" class="text-muted text-center">No truck data available</td>
            </tr>
          </ng-template>
        </p-table>
      </ui-dashboard-card>
    </div>
  </div>

  <!-- DVIR Defect Rate Card -->
  <div class="grid grid-cols-12 gap-2">
    <div class="col-span-12 mb-6">
      <ui-dashboard-card title="DVIR Summary" icon="pi-clipboard" iconColor="blue">
        <div class="grid grid-cols-12 gap-4 p-4">
          <div class="col-span-12 md:col-span-4">
            <div class="text-muted text-sm">DVIRs with Defects</div>
            <div class="text-2xl font-semibold">{{ data()?.dvirsWithDefects || 0 }}</div>
          </div>
          <div class="col-span-12 md:col-span-4">
            <div class="text-muted text-sm">Defect Rate</div>
            <div class="text-2xl font-semibold" [class]="getDefectRateClass(data()?.dvirDefectRate)">
              {{ (data()?.dvirDefectRate || 0 | number: '1.1-1') }}%
            </div>
          </div>
          <div class="col-span-12 md:col-span-4">
            <div class="text-muted text-sm">Pending Reviews</div>
            <div class="text-2xl font-semibold text-amber-600">{{ data()?.pendingDvirReviews || 0 }}</div>
          </div>
        </div>
      </ui-dashboard-card>
    </div>
  </div>
}
