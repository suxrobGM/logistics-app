<ui-page-header title="Review DVIR Report" [showAddButton]="false" [backLink]="'/safety/dvir/' + id()" />

@if (isLoading()) {
  <div class="flex justify-center py-16">
    <p-progress-spinner />
  </div>
} @else if (report()) {
  <div class="grid grid-cols-1 gap-4 lg:grid-cols-3">
    <!-- Report Summary -->
    <div class="lg:col-span-2">
      <p-card header="Report Summary">
        <div class="grid grid-cols-2 gap-4 md:grid-cols-4">
          <div>
            <div class="text-muted mb-1 text-sm">Truck</div>
            <div class="font-medium">{{ report()!.truckNumber }}</div>
          </div>
          <div>
            <div class="text-muted mb-1 text-sm">Driver</div>
            <div class="font-medium">{{ report()!.driverName }}</div>
          </div>
          <div>
            <div class="text-muted mb-1 text-sm">Type</div>
            <div class="font-medium">{{ report()!.type === "pre_trip" ? "Pre-Trip" : "Post-Trip" }}</div>
          </div>
          <div>
            <div class="text-muted mb-1 text-sm">Defects Found</div>
            <div class="font-medium">{{ report()!.defects?.length ?? 0 }}</div>
          </div>
        </div>

        @if (report()!.driverNotes) {
          <div class="mt-4">
            <div class="text-muted mb-1 text-sm">Driver Notes</div>
            <p>{{ report()!.driverNotes }}</p>
          </div>
        }
      </p-card>

      <!-- Defects to Review -->
      @if (report()!.defects && report()!.defects!.length > 0) {
        <p-card header="Defects to Review" class="mt-4">
          <app-dvir-defects-list [defects]="report()!.defects!" />
        </p-card>
      }
    </div>

    <!-- Review Form -->
    <div>
      <p-card header="Your Review">
        <form [formGroup]="form" (ngSubmit)="submitReview()">
          <ui-validation-summary [form]="form" />

          @if (report()!.hasDefects) {
            <ui-labeled-field label="All Defects Corrected?" class="mb-4">
              <div class="flex items-center gap-2">
                <p-toggleswitch formControlName="defectsCorrected" />
                <span class="text-sm">{{ form.value.defectsCorrected ? "Yes" : "No" }}</span>
              </div>
            </ui-labeled-field>
          }

          <ui-labeled-field label="Mechanic Notes" for="mechanicNotes">
            <textarea
              pInputTextarea
              formControlName="mechanicNotes"
              id="mechanicNotes"
              class="w-full"
              rows="4"
              placeholder="Enter any notes about repairs or observations..."
            ></textarea>
          </ui-labeled-field>

          <div class="mt-6 flex flex-col gap-2">
            <p-button
              type="submit"
              icon="pi pi-check"
              label="Submit Review"
              class="w-full"
              [loading]="isSaving()"
              [disabled]="isSaving()"
            />
            <p-button
              type="button"
              icon="pi pi-times"
              label="Cancel"
              severity="secondary"
              [outlined]="true"
              class="w-full"
              [disabled]="isSaving()"
              (click)="cancel()"
            />
          </div>
        </form>
      </p-card>
    </div>
  </div>
}
