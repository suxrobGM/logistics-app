<div class="animate-fadein">
  <div class="flex items-center">
    <h1 class="text-primary mb-0">Trips</h1>
    <p-button
      styleClass="ml-2"
      icon="pi pi-plus-circle"
      size="large"
      [rounded]="true"
      [text]="true"
      pTooltip="Add a new trip"
      aria-label="Add a new trip"
      [routerLink]="['/trips/add']"
    />
  </div>

  <!-- Filter Panel -->
  <p-card class="mb-4">
    <div class="mb-4 flex items-center justify-between">
      <span class="text-primary text-lg font-semibold">Filters</span>
      <div class="flex items-center gap-2">
        @if (activeFilterCount() > 0) {
          <span class="text-muted text-sm">{{ activeFilterCount() }} active</span>
        }
        <p-button
          label="Clear All"
          icon="pi pi-times"
          size="small"
          [text]="true"
          (click)="clearFilters()"
          [disabled]="activeFilterCount() === 0"
        />
      </div>
    </div>

    <div class="grid grid-cols-1 gap-x-4 md:grid-cols-2 lg:grid-cols-4">
      <ui-labeled-field label="Search">
        <ui-search-input class="w-full" (searchChange)="onSearch($event)" />
      </ui-labeled-field>

      <ui-labeled-field label="Status">
        <p-multiselect
          [options]="statusOptions"
          [ngModel]="selectedStatuses()"
          (ngModelChange)="selectedStatuses.set($event); applyFilters()"
          placeholder="Select status"
          [showClear]="true"
          class="w-full"
        />
      </ui-labeled-field>

      <ui-labeled-field label="Truck">
        <app-search-truck
          [selectedTruck]="selectedTruck()"
          (selectedTruckChange)="selectedTruck.set($event); applyFilters()"
        />
      </ui-labeled-field>

      <ui-labeled-field label="Date Range">
        <ui-date-range-picker (datesChange)="onDateRangeChange($event)" />
      </ui-labeled-field>
    </div>

    <div class="mt-4 flex flex-wrap items-center gap-x-6 gap-y-2">
      <div class="flex items-center gap-2">
        <p-checkbox
          [ngModel]="onlyActiveTrips()"
          (ngModelChange)="onlyActiveTrips.set($event); applyFilters()"
          [binary]="true"
          inputId="activeTripsOnly"
        />
        <label for="activeTripsOnly" class="text-secondary cursor-pointer text-sm"
          >Active trips only</label
        >
      </div>
    </div>
  </p-card>

  <p-card>
    <ui-data-container
      [loading]="store.isLoading()"
      [error]="store.error()"
      [isEmpty]="store.isEmpty()"
      skeletonVariant="table"
      [skeletonRows]="10"
      emptyTitle="No trips yet"
      emptyMessage="Create your first trip to get started."
      emptyActionLabel="Add Trip"
      (retry)="store.retry()"
      (emptyAction)="addTrip()"
    >
      <p-table
        [value]="store.data()"
        [dataKey]="'id'"
        [scrollable]="true"
        [lazy]="true"
        [paginator]="true"
        [showCurrentPageReport]="true"
        (onLazyLoad)="store.onLazyLoad($event)"
        [rows]="store.pageSize()"
        [first]="store.first()"
        [totalRecords]="store.totalRecords()"
        [loading]="store.isLoading()"
        [rowsPerPageOptions]="[10, 25, 50]"
      >
        <ng-template #header>
          <tr>
            <th></th>
            <th pSortableColumn="Number">
              Number
              <p-sortIcon field="Number" />
            </th>
            <th pSortableColumn="Name">
              Name
              <p-sortIcon field="Name" />
            </th>
            <th pSortableColumn="Truck.Number">
              Truck
              <p-sortIcon field="Truck.Number" />
            </th>
            <th>Loads</th>
            <th>Total Revenue</th>
            <th pSortableColumn="OriginAddress.Line1">
              Origin
              <p-sortIcon field="OriginAddress.Line1" />
            </th>
            <th pSortableColumn="DestinationAddress.Line1">
              Destination
              <p-sortIcon field="DestinationAddress.Line1" />
            </th>
            <th pSortableColumn="TotalDistance">
              Distance (mi)
              <p-sortIcon field="TotalDistance" />
            </th>
            <th pSortableColumn="Status">
              Status
              <p-sortIcon field="Status" />
            </th>
            <th>Action</th>
          </tr>
        </ng-template>
        <ng-template #body let-trip let-expanded="expanded">
          <tr class="hover:bg-hover transition-colors duration-150" (click)="selectedRow.set(trip)">
            <td>
              <p-button
                [pRowToggler]="trip"
                class="mr-2 text-sm no-underline"
                [icon]="expanded ? 'pi pi-chevron-down' : 'pi pi-chevron-right'"
                variant="text"
                aria-label="Toggle trip details"
              />
            </td>
            <td class="text-center font-medium">{{ trip.number }}</td>
            <td>
              <span
                class="block max-w-32 truncate"
                [pTooltip]="trip.name"
                [showDelay]="500"
                tooltipPosition="bottom"
              >
                {{ trip.name }}
              </span>
            </td>
            <td class="text-center">{{ trip.truckNumber }}</td>
            <td class="text-center">{{ trip.loadsCount }}</td>
            <td class="text-right">{{ trip.totalRevenue | currency }}</td>
            <td>
              <span
                class="block max-w-28 truncate"
                [pTooltip]="trip.originAddress | address"
                [showDelay]="500"
                tooltipPosition="bottom"
              >
                {{ trip.originAddress | address }}
              </span>
            </td>
            <td>
              <span
                class="block max-w-28 truncate"
                [pTooltip]="trip.destinationAddress | address"
                [showDelay]="500"
                tooltipPosition="bottom"
              >
                {{ trip.destinationAddress | address }}
              </span>
            </td>
            <td class="text-center">{{ trip.totalDistance | distanceUnit: "mi" }}</td>
            <td>
              <app-trip-status-tag [status]="trip.status" />
              <div class="text-muted text-xs italic">
                @switch (trip.status) {
                  @case ("dispatched") {
                    {{ trip.dispatchedAt | date: "mediumDate" }}
                  }
                  @case ("completed") {
                    {{ trip.completedAt | date: "mediumDate" }}
                  }
                }
              </div>
            </td>
            <td>
              <p-button
                icon="pi pi-ellipsis-v"
                [text]="true"
                (click)="menu.toggle($event)"
                aria-label="Show actions menu"
              />
            </td>
          </tr>
        </ng-template>
        <ng-template #expandedrow let-trip>
          <tr>
            <td colspan="11">
              <div class="p-4">
                <h5 class="mb-4">Loads in this trip</h5>
                <p-table [value]="trip.loads" [dataKey]="'id'">
                  <ng-template #header>
                    <tr>
                      <th pSortableColumn="number">Load Number <p-sortIcon field="number" /></th>
                      <th pSortableColumn="name">Load Name <p-sortIcon field="name" /></th>
                      <th pSortableColumn="type">Load Type <p-sortIcon field="type" /></th>
                      <th pSortableColumn="customer.name">
                        Customer <p-sortIcon field="customer.name" />
                      </th>
                      <th pSortableColumn="originAddress.line1">
                        Origin <p-sortIcon field="originAddress.line1" />
                      </th>
                      <th pSortableColumn="destinationAddress.line1">
                        Destination <p-sortIcon field="destinationAddress.line1" />
                      </th>
                      <th pSortableColumn="status">Status <p-sortIcon field="status" /></th>
                      <th pSortableColumn="distance">
                        Distance (mi) <p-sortIcon field="distance" />
                      </th>
                      <th pSortableColumn="deliveryCost">
                        Delivery Cost <p-sortIcon field="deliveryCost" />
                      </th>
                    </tr>
                  </ng-template>
                  <ng-template #body let-load>
                    <tr>
                      <td class="text-center">{{ load.number }}</td>
                      <td>
                        <span
                          class="block max-w-32 truncate"
                          [pTooltip]="load.name"
                          [showDelay]="500"
                          tooltipPosition="bottom"
                        >
                          {{ load.name }}
                        </span>
                      </td>
                      <td><app-load-type-tag [type]="load.type" /></td>
                      <td>
                        <span
                          class="block max-w-28 truncate"
                          [pTooltip]="load.customer.name"
                          [showDelay]="500"
                          tooltipPosition="bottom"
                        >
                          {{ load.customer.name }}
                        </span>
                      </td>
                      <td>
                        <span
                          class="block max-w-28 truncate"
                          [pTooltip]="load.originAddress | address"
                          [showDelay]="500"
                          tooltipPosition="bottom"
                        >
                          {{ load.originAddress | address }}
                        </span>
                      </td>
                      <td>
                        <span
                          class="block max-w-28 truncate"
                          [pTooltip]="load.destinationAddress | address"
                          [showDelay]="500"
                          tooltipPosition="bottom"
                        >
                          {{ load.destinationAddress | address }}
                        </span>
                      </td>
                      <td><app-load-status-tag [status]="load.status" /></td>
                      <td class="text-center">{{ load.distance | distanceUnit: "mi" }}</td>
                      <td class="text-right">{{ load.deliveryCost | currency }}</td>
                    </tr>
                  </ng-template>
                  <ng-template #footer>
                    <tr>
                      <td colspan="7"></td>
                      <td class="text-right font-semibold">Total:</td>
                      <td class="text-right font-semibold">{{ trip.totalRevenue | currency }}</td>
                    </tr>
                  </ng-template>
                </p-table>
              </div>
            </td>
          </tr>
        </ng-template>
      </p-table>
    </ui-data-container>
  </p-card>

  <!-- Reusable context menu for the actions button -->
  <p-menu #menu [model]="actionMenuItems" [popup]="true" />
</div>
