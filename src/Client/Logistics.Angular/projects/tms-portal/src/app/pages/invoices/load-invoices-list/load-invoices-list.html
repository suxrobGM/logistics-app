<div class="animate-fadein">
  <div class="mb-4 flex items-center justify-between">
    <h1 class="text-primary">Load Invoices</h1>
    <a routerLink="/invoices" class="no-underline">
      <p-button icon="pi pi-chart-bar" label="Dashboard" [outlined]="true" />
    </a>
  </div>

  <!-- Filter Panel (hidden when viewing specific load's invoices) -->
  @if (!isLoadSpecific()) {
    <p-card class="mb-4">
      <div class="mb-4 flex items-center justify-between">
        <span class="text-primary text-lg font-semibold">Filters</span>
        <div class="flex items-center gap-2">
          @if (activeFilterCount() > 0) {
            <span class="text-muted text-sm">{{ activeFilterCount() }} active</span>
          }
          <p-button
            label="Clear All"
            icon="pi pi-times"
            size="small"
            [text]="true"
            (click)="clearFilters()"
            [disabled]="activeFilterCount() === 0"
          />
        </div>
      </div>

      <div class="grid grid-cols-1 gap-x-4 md:grid-cols-2 lg:grid-cols-4">
        <ui-labeled-field label="Search">
          <ui-search-input class="w-full" (searchChange)="onSearch($event)" />
        </ui-labeled-field>

        <ui-labeled-field label="Status">
          <p-multiselect
            [options]="statusOptions"
            [(ngModel)]="selectedStatuses"
            placeholder="Select status"
            [showClear]="true"
            (onChange)="applyFilters()"
            class="w-full"
          />
        </ui-labeled-field>

        <ui-labeled-field label="Customer">
          <app-search-customer
            [(selectedCustomer)]="selectedCustomer"
            (selectedCustomerChange)="applyFilters()"
          />
        </ui-labeled-field>

        <ui-labeled-field label="Date Range">
          <ui-date-range-picker (datesChange)="onDateRangeChange($event)" />
        </ui-labeled-field>
      </div>

      <div class="mt-4 flex items-center gap-4">
        <div class="flex items-center gap-2">
          <p-checkbox
            [(ngModel)]="overdueOnly"
            [binary]="true"
            inputId="overdueOnly"
            (onChange)="applyFilters()"
          />
          <label
            for="overdueOnly"
            class="text-secondary mb-0 cursor-pointer text-sm dark:text-gray-300"
          >
            Overdue invoices only
          </label>
        </div>
      </div>
    </p-card>
  }

  <!-- Selection Toolbar -->
  @if (selectedInvoices().length > 0) {
    <p-toolbar styleClass="mb-4">
      <ng-template #start>
        <span class="font-semibold">{{ selectedInvoices().length }} selected</span>
      </ng-template>
      <ng-template #end>
        <p-button
          icon="pi pi-times"
          label="Clear Selection"
          [text]="true"
          (click)="clearSelection()"
        />
      </ng-template>
    </p-toolbar>
  }

  <p-card>
    <ui-data-container
      [loading]="store.isLoading()"
      [error]="store.error()"
      [isEmpty]="store.isEmpty()"
      skeletonVariant="table"
      [skeletonRows]="10"
      emptyTitle="No load invoices yet"
      emptyMessage="Invoices will appear here once loads are created."
      (retry)="store.retry()"
    >
      <p-table
        [value]="store.data()"
        [lazy]="true"
        [paginator]="true"
        [showCurrentPageReport]="true"
        (onLazyLoad)="store.onLazyLoad($event)"
        [rows]="store.pageSize()"
        [first]="store.first()"
        [totalRecords]="store.totalRecords()"
        [loading]="store.isLoading()"
        [rowsPerPageOptions]="[10, 25, 50]"
        [(selection)]="selectedInvoices"
        dataKey="id"
        (selectionChange)="onSelectionChange($any($event))"
      >
        <ng-template #header>
          <tr>
            <th style="width: 3rem">
              <p-tableHeaderCheckbox />
            </th>
            <th pSortableColumn="Number">
              Invoice #
              <p-sortIcon field="Number" />
            </th>
            <th pSortableColumn="Load.Number">
              Load #
              <p-sortIcon field="Load.Number" />
            </th>
            <th pSortableColumn="Customer.Name">
              Customer
              <p-sortIcon field="Customer.Name" />
            </th>
            <th pSortableColumn="Total">
              Amount
              <p-sortIcon field="Total" />
            </th>
            <th pSortableColumn="CreatedDate">
              Issue Date
              <p-sortIcon field="CreatedDate" />
            </th>
            <th pSortableColumn="DueDate">
              Due Date
              <p-sortIcon field="DueDate" />
            </th>
            <th pSortableColumn="Status">
              Status
              <p-sortIcon field="Status" />
            </th>
            <th style="width: 10rem">Actions</th>
          </tr>
        </ng-template>

        <ng-template #body let-invoice>
          <tr [class.bg-red-50]="isOverdue(invoice)">
            <td>
              <p-tableCheckbox [value]="invoice" />
            </td>
            <td>
              <a
                [routerLink]="['/invoices/loads', invoice.loadId, invoice.id]"
                class="text-primary font-medium hover:underline"
              >
                {{ invoice.number }}
              </a>
            </td>
            <td>
              <a [routerLink]="['/loads', invoice.loadId]" class="text-primary hover:underline">
                {{ invoice.loadNumber }}
              </a>
            </td>
            <td>{{ invoice.customer?.name ?? "-" }}</td>
            <td class="text-right">{{ invoice.total?.amount | currency }}</td>
            <td>{{ invoice.createdDate | date: "shortDate" }}</td>
            <td>
              @if (invoice.dueDate) {
                <span [class.text-red-600]="isOverdue(invoice)">
                  {{ invoice.dueDate | date: "shortDate" }}
                </span>
                @if (isOverdue(invoice)) {
                  <i class="pi pi-exclamation-triangle ml-1 text-red-600" pTooltip="Overdue"></i>
                }
              } @else {
                -
              }
            </td>
            <td>
              <app-invoice-status-tag [status]="invoice.status" />
            </td>
            <td>
              <div class="flex gap-1">
                <p-button
                  icon="pi pi-eye"
                  [rounded]="true"
                  [text]="true"
                  pTooltip="View Details"
                  [routerLink]="['/invoices/loads', invoice.loadId, invoice.id]"
                />
                <p-button
                  icon="pi pi-send"
                  [rounded]="true"
                  [text]="true"
                  pTooltip="Send Invoice"
                  (click)="openSendDialog(invoice)"
                />
              </div>
            </td>
          </tr>
        </ng-template>
      </p-table>
    </ui-data-container>
  </p-card>

  <!-- Send Invoice Dialog -->
  @if (selectedInvoiceId()) {
    <app-send-invoice-dialog
      [invoiceId]="selectedInvoiceId()!"
      [(visible)]="showSendInvoiceDialog"
      (sent)="onInvoiceSent()"
    />
  }
</div>
