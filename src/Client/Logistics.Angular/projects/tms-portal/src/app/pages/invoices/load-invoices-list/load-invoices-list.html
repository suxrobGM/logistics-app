<div class="animate-fadein">
  <div class="mb-4 flex items-center justify-between">
    <h1 class="text-primary mb-0">Load Invoices</h1>
    <a routerLink="/invoices" class="no-underline">
      <p-button icon="pi pi-chart-bar" label="Dashboard" [outlined]="true" />
    </a>
  </div>

  <!-- Filter Panel -->
  <p-card class="mb-4">
    <div class="mb-4 flex items-center justify-between">
      <span class="text-primary text-lg font-semibold">Filters</span>
      <div class="flex items-center gap-2">
        @if (activeFilterCount() > 0) {
          <span class="text-muted text-sm">{{ activeFilterCount() }} active</span>
        }
        <p-button
          label="Clear All"
          icon="pi pi-times"
          size="small"
          [text]="true"
          (click)="clearFilters()"
          [disabled]="activeFilterCount() === 0"
        />
      </div>
    </div>

    <div class="grid grid-cols-1 gap-x-4 md:grid-cols-2 lg:grid-cols-3">
      <ui-labeled-field label="Search">
        <ui-search-input
          class="w-full"
          placeholder="Search by customer or invoice #"
          (searchChange)="onSearch($event)"
        />
      </ui-labeled-field>

      <ui-labeled-field label="Status">
        <p-multiselect
          [options]="statusOptions"
          [(ngModel)]="selectedStatuses"
          placeholder="Select status"
          [showClear]="true"
          (onChange)="applyFilters()"
          class="w-full"
        />
      </ui-labeled-field>

      <ui-labeled-field label="Date Range">
        <ui-date-range-picker (datesChange)="onDateRangeChange($event)" />
      </ui-labeled-field>
    </div>
  </p-card>

  <p-card>
    <ui-data-container
      [loading]="store.isLoading()"
      [error]="store.error()"
      [isEmpty]="store.isEmpty()"
      skeletonVariant="table"
      [skeletonRows]="10"
      emptyTitle="No load invoices yet"
      emptyMessage="Load invoices are automatically created when loads are added."
      (retry)="store.retry()"
    >
      <p-table
        [value]="store.data()"
        [lazy]="true"
        [paginator]="true"
        [showCurrentPageReport]="true"
        (onLazyLoad)="store.onLazyLoad($event)"
        [rows]="store.pageSize()"
        [first]="store.first()"
        [totalRecords]="store.totalRecords()"
        [loading]="store.isLoading()"
        [rowsPerPageOptions]="[10, 25, 50]"
        dataKey="id"
      >
        <ng-template #header>
          <tr>
            <th pSortableColumn="Number">
              Invoice #
              <p-sortIcon field="Number" />
            </th>
            <th pSortableColumn="LoadNumber">
              Load #
              <p-sortIcon field="LoadNumber" />
            </th>
            <th pSortableColumn="Customer.Name">
              Customer
              <p-sortIcon field="Customer.Name" />
            </th>
            <th pSortableColumn="Total">
              Amount
              <p-sortIcon field="Total" />
            </th>
            <th pSortableColumn="Status">
              Status
              <p-sortIcon field="Status" />
            </th>
            <th pSortableColumn="CreatedDate">
              Created
              <p-sortIcon field="CreatedDate" />
            </th>
            <th pSortableColumn="DueDate">
              Due Date
              <p-sortIcon field="DueDate" />
            </th>
            <th style="width: 6rem">Actions</th>
          </tr>
        </ng-template>

        <ng-template #body let-invoice>
          <tr>
            <td>
              <a [routerLink]="getInvoiceLink(invoice)">
                {{ invoice.number }}
              </a>
            </td>
            <td>
              <a [routerLink]="['/loads', invoice.loadId]">
                {{ invoice.loadNumber ?? "-" }}
              </a>
            </td>
            <td>{{ invoice.customer?.name ?? "-" }}</td>
            <td>{{ invoice.total?.amount | currencyFormat }}</td>
            <td><app-invoice-status-tag [status]="invoice.status" /></td>
            <td>{{ invoice.createdDate | dateFormat: "shortDate" }}</td>
            <td>{{ invoice.dueDate | dateFormat: "shortDate" }}</td>
            <td>
              <a [routerLink]="getInvoiceLink(invoice)">
                <p-button
                  icon="pi pi-eye"
                  [rounded]="true"
                  [text]="true"
                  pTooltip="View Details"
                  tooltipPosition="top"
                />
              </a>
            </td>
          </tr>
        </ng-template>

        <ng-template #emptymessage>
          <tr>
            <td colspan="8" class="p-4 text-center text-gray-500">No invoices found</td>
          </tr>
        </ng-template>
      </p-table>
    </ui-data-container>
  </p-card>
</div>
