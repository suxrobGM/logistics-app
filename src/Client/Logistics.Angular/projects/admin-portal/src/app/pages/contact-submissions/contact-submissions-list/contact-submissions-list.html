<ui-page-header title="Contact Submissions" />

<p-card>
  <ui-data-container
    [loading]="store.isLoading()"
    [error]="store.error()"
    [isEmpty]="store.isEmpty()"
    skeletonVariant="table"
    [skeletonRows]="10"
    emptyTitle="No contact submissions yet"
    emptyMessage="Contact submissions from the website will appear here."
    (retry)="store.retry()"
  >
    <p-table
      [value]="store.data()"
      [lazy]="true"
      [paginator]="true"
      [showCurrentPageReport]="true"
      (onLazyLoad)="store.onLazyLoad($event)"
      [rows]="store.pageSize()"
      [first]="store.first()"
      [totalRecords]="store.totalRecords()"
      [loading]="store.isLoading()"
      [rowsPerPageOptions]="[10, 25, 50]"
    >
      <ng-template #caption>
        <ui-search-input (searchChange)="search($event)" />
      </ng-template>
      <ng-template #header>
        <tr>
          <th pSortableColumn="FirstName">
            Name
            <p-sortIcon field="FirstName" />
          </th>
          <th pSortableColumn="Email">
            Email
            <p-sortIcon field="Email" />
          </th>
          <th pSortableColumn="Subject">
            Subject
            <p-sortIcon field="Subject" />
          </th>
          <th pSortableColumn="Status">
            Status
            <p-sortIcon field="Status" />
          </th>
          <th pSortableColumn="CreatedAt">
            Submitted
            <p-sortIcon field="CreatedAt" />
          </th>
          <th class="text-center">Actions</th>
        </tr>
      </ng-template>
      <ng-template #body let-submission>
        <tr>
          <td>{{ submission.firstName }} {{ submission.lastName }}</td>
          <td>{{ submission.email }}</td>
          <td>{{ getSubjectLabel(submission.subject) }}</td>
          <td>
            <p-tag
              [value]="getStatusLabel(submission.status)"
              [severity]="getStatusSeverity(submission.status)"
            />
          </td>
          <td>{{ formatDate(submission.createdAt) }}</td>
          <td class="text-center">
            <p-button icon="pi pi-eye" pTooltip="View Details" (click)="viewSubmission(submission)" />
            <p-button
              styleClass="ml-2 p-button-danger"
              icon="pi pi-trash"
              pTooltip="Delete"
              (click)="confirmToDelete(submission.id)"
            />
          </td>
        </tr>
      </ng-template>
    </p-table>
  </ui-data-container>
</p-card>

<p-dialog
  header="Contact Submission Details"
  [(visible)]="viewDialogVisible"
  [modal]="true"
  [style]="{ width: '600px' }"
>
  @if (selectedSubmission(); as submission) {
    <div class="flex flex-col gap-4">
      <div class="grid grid-cols-2 gap-4">
        <div>
          <span class="mb-1 block text-sm font-medium text-gray-500">Name</span>
          <p class="text-base">{{ submission.firstName }} {{ submission.lastName }}</p>
        </div>
        <div>
          <span class="mb-1 block text-sm font-medium text-gray-500">Email</span>
          <p class="text-base">{{ submission.email }}</p>
        </div>
        <div>
          <span class="mb-1 block text-sm font-medium text-gray-500">Phone</span>
          <p class="text-base">{{ submission.phone ?? "-" }}</p>
        </div>
        <div>
          <span class="mb-1 block text-sm font-medium text-gray-500">Subject</span>
          <p class="text-base">{{ getSubjectLabel(submission.subject) }}</p>
        </div>
        <div>
          <span class="mb-1 block text-sm font-medium text-gray-500">Submitted</span>
          <p class="text-base">{{ formatDate(submission.createdAt) }}</p>
        </div>
        @if (submission.updatedAt) {
          <div>
            <span class="mb-1 block text-sm font-medium text-gray-500">Last Updated</span>
            <p class="text-base">{{ formatDate(submission.updatedAt) }}</p>
          </div>
        }
      </div>

      <div>
        <span class="mb-1 block text-sm font-medium text-gray-500">Message</span>
        <p class="rounded bg-gray-50 p-3 text-base">{{ submission.message }}</p>
      </div>

      <form [formGroup]="form" class="mt-2 border-t pt-4">
        <div class="grid grid-cols-12 gap-4">
          <div class="col-span-12 md:col-span-6">
            <ui-labeled-field label="Status">
              <p-select
                formControlName="status"
                [options]="statusOptions"
                optionLabel="label"
                optionValue="value"
                class="w-full"
              />
            </ui-labeled-field>
          </div>

          <div class="col-span-12">
            <ui-labeled-field label="Internal Notes">
              <textarea
                pInputTextarea
                formControlName="notes"
                rows="3"
                class="w-full"
                placeholder="Add notes about this submission..."
              ></textarea>
            </ui-labeled-field>
          </div>
        </div>
      </form>
    </div>
  }

  <ng-template #footer>
    <p-button label="Cancel" severity="secondary" (click)="viewDialogVisible.set(false)" />
    <p-button label="Save Changes" icon="pi pi-check" (click)="saveSubmission()" />
  </ng-template>
</p-dialog>
