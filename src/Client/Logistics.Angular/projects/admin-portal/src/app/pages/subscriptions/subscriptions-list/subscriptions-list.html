<shared-page-header title="Subscriptions" addRoute="/subscriptions/add" addTooltip="Add a new subscription" />

<p-card>
  <shared-data-container
    [loading]="store.isLoading()"
    [error]="store.error()"
    [isEmpty]="store.isEmpty()"
    skeletonVariant="table"
    [skeletonRows]="10"
    emptyTitle="No subscriptions yet"
    emptyMessage="Add your first subscription to get started."
    emptyActionLabel="Add Subscription"
    (retry)="store.retry()"
    (emptyAction)="addSubscription()"
  >
    <p-table
      [value]="store.data()"
      [lazy]="true"
      [paginator]="true"
      [showCurrentPageReport]="true"
      (onLazyLoad)="store.onLazyLoad($event)"
      [rows]="store.pageSize()"
      [first]="store.first()"
      [totalRecords]="store.totalRecords()"
      [loading]="store.isLoading()"
      [rowsPerPageOptions]="[10, 25, 50]"
    >
      <ng-template #caption>
        <shared-search-input (searchChange)="search($event)" />
      </ng-template>
      <ng-template #header>
        <tr>
          <th>Tenant</th>
          <th>Plan</th>
          <th>Status</th>
          <th pSortableColumn="StartDate">
            Start Date
            <p-sortIcon field="StartDate" />
          </th>
          <th>Next Billing</th>
          <th class="text-center">Actions</th>
        </tr>
      </ng-template>
      <ng-template #body let-sub>
        <tr>
          <td>
            <a [routerLink]="['/tenants', sub.tenant?.id, 'edit']" class="font-medium">
              {{ sub.tenant?.name ?? 'Unknown' }}
            </a>
          </td>
          <td>{{ sub.plan?.name ?? '-' }}</td>
          <td>
            <p-tag
              [value]="sub.status ?? 'unknown'"
              [severity]="getStatusSeverity(sub.status)"
            />
          </td>
          <td>{{ sub.startDate | date:'mediumDate' }}</td>
          <td>{{ sub.nextBillingDate | date:'mediumDate' }}</td>
          <td class="text-center">
            @if (sub.status === 'active' || sub.status === 'trialing') {
              <p-button
                icon="pi pi-times-circle"
                pTooltip="Cancel Subscription"
                severity="warn"
                [outlined]="true"
                (click)="confirmToCancel(sub.id)"
              />
            }
            <p-button
              styleClass="ml-2 p-button-danger"
              icon="pi pi-trash"
              pTooltip="Delete Subscription"
              (click)="confirmToDelete(sub.id)"
            />
          </td>
        </tr>
      </ng-template>
    </p-table>
  </shared-data-container>
</p-card>
