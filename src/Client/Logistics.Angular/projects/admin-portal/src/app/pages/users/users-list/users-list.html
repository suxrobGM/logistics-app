<ui-page-header title="Users" />

<p-card>
  <ui-data-container
    [loading]="store.isLoading()"
    [error]="store.error()"
    [isEmpty]="store.isEmpty()"
    skeletonVariant="table"
    [skeletonRows]="10"
    emptyTitle="No users found"
    emptyMessage="There are no users in the system."
    (retry)="store.retry()"
  >
    <p-table
      [value]="store.data()"
      [lazy]="true"
      [paginator]="true"
      [showCurrentPageReport]="true"
      (onLazyLoad)="store.onLazyLoad($event)"
      [rows]="store.pageSize()"
      [first]="store.first()"
      [totalRecords]="store.totalRecords()"
      [loading]="store.isLoading()"
      [rowsPerPageOptions]="[10, 25, 50]"
    >
      <ng-template #caption>
        <ui-search-input (searchChange)="search($event)" />
      </ng-template>
      <ng-template #header>
        <tr>
          <th pSortableColumn="Email">
            Email
            <p-sortIcon field="Email" />
          </th>
          <th>Name</th>
          <th>Role</th>
          <th>Tenant</th>
          <th>Phone</th>
          <th class="w-24">Actions</th>
        </tr>
      </ng-template>
      <ng-template #body let-user>
        <tr>
          <td>{{ user.email }}</td>
          <td>{{ getFullName(user) }}</td>
          <td>
            <p-tag [value]="user.role ?? 'Unknown'" [severity]="getRoleSeverity(user.role)" />
          </td>
          <td>
            @if (user.tenantId) {
              <a [routerLink]="['/tenants', user.tenantId, 'edit']">
                {{ user.tenantName ?? "View Tenant" }}
              </a>
            } @else {
              <span class="text-gray-400">-</span>
            }
          </td>
          <td>{{ user.phoneNumber ?? "-" }}</td>
          <td>
            <p-button
              icon="pi pi-user"
              severity="secondary"
              size="small"
              [text]="true"
              pTooltip="Impersonate User"
              (onClick)="openImpersonateDialog(user.email)"
            />
          </td>
        </tr>
      </ng-template>
    </p-table>
  </ui-data-container>
</p-card>

<!-- Impersonate Dialog -->
<p-dialog
  header="Impersonate User"
  [(visible)]="showImpersonateDialog"
  [modal]="true"
  [style]="{ width: '400px' }"
>
  <div class="flex flex-col gap-4">
    <p class="text-gray-600">
      You are about to impersonate
      <strong>{{ impersonateEmail() }}</strong>
      . Enter the master password to continue.
    </p>
    <div class="flex flex-col gap-2">
      <label for="masterPassword" class="font-medium">Master Password</label>
      <p-password
        id="masterPassword"
        [(ngModel)]="masterPassword"
        [feedback]="false"
        [toggleMask]="true"
        inputStyleClass="w-full"
        placeholder="Enter master password"
      />
    </div>
  </div>
  <ng-template #footer>
    <p-button label="Cancel" severity="secondary" (onClick)="showImpersonateDialog.set(false)" />
    <p-button
      label="Impersonate"
      icon="pi pi-user"
      [loading]="isImpersonating()"
      (onClick)="impersonate()"
    />
  </ng-template>
</p-dialog>
